# Introduction to Jenkins Pipelines

Jenkins is a widely used platform for automating the process of integrating new changes into deployed code. It belongs to an area called CI/CD continuous integration or continuous deployment. The dream here is to automate the steps required to deploy code after updates or changes have been made.

❓ Why do you think senior developers are really keen on this kind of deployment?

For your apprenticeship there are some skills that you'll need to demonstrate related to this topic and they are:

S10: build, manage and deploy code into the relevant environment
S11: apply an appropriate software development approach according to the relevant paradigm (jenkins piplines are event driven or procedural)
S14: follow company, team or client approaches to continuous integration, version and source control

## Lets go!

The aim of this workshop is to take a software project and deploy it into AWS. You will have completed the workshop challenge when you can make a change to the code base, push your changes and then without touching anything have your change propogate to the live version of your app running on AWS. This is called continuos deployment.

![Screen shot of the mood tracker app](https://user-images.githubusercontent.com/4499581/216276344-f345e807-c554-4cd1-88f2-e5c1229011f5.png)

### Breaking down the steps

The software project is here. Can you down load this unzip it and try to get it running locally.

[Moodtracker App](https://github.com/MultiverseLearningProducts/java-moodtracker-app/archive/refs/tags/1.0.0.zip)

We are going to start by trying to execute the steps manually. This is helpful for us so we can make sure we have every credential, secret and setting correct before we automate the process.

* Put this project in your own bitbucket/source control
* Run the app locally
* Test the app using `gradle clean test`
* Build the app with `gradle bootJar`
* Dockerize the app `docker build -t ${your_docker_username}/moodtracker .`
* Push the image to DockerHub `docker push ${your_docker_username}/moodtracker`
* Create an EC2 instance and install docker (see below)
* On the EC2 instance add a `docker-compose.yaml` file with the environmental variables ports etc
* Pull and run the updated container via `docker compose up -d`

To install docker on EC2 use the commands below:

```sh
sudo yum update -y
sudo yum install docker -y
sudo service docker start
sudo usermod -a -G docker ec2-user
```

The environmental variables the app needs to be tested, built or run are:

```
MOD2_AUTH0_CLIENT_ID=•••••••••••••••••
MOD2_AUTH0_CLIENT_SECRET=•••••••••••••••••••••••••••••••••••••••••••••••••••
MOD2_AUTH0_ISSUER=•••••••••••••••••
```
Your coach can share these with you or you can set up your own Auth0 project.

## Automation with Jenkins

We can run our own local instance of Jenkins. Below is a `docker-compose.yaml` that you can use. Update this with a path to keep all the Jenkins file somewhere on your file system. For this to work you have to have docker installed and running on your host machine.

```yaml
version: "3"
services:
  jenkins:
    container_name: jenkins
    image: bmordan/jenkins-with-docker
    privileged: true
    user: root
    ports:
      - 8080:8080
      - 50000:50000
    volumes:
      - ${YOUR_PATH_ON_YOUR_FILE_SYSTEM}:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - jenkins
networks:
  jenkins:
```

Start the service with `docker compoe up -d` visit `http://localhost:8080`. You will need the admin password which is in the container. You can access the password with the following docker command:

```
docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
```

You can create an admin user and log in. Skip installing plugins (we will come back to that). What we are now looking at is an instance of Jenkins. We can use this to program automations of all kinds. It is a versatile and powerful platform with a plugin architecture. So if Jenkins doesn't yet do what you need it to, you can extend it by writing your own plugin.

Let's create our first pipeline.

1. Go to add a new item -> give it the name "Hello World" -> Select 'Pipeline'
1. Scroll down to the __Pipeline__ section select __Pipeline script__
1. Add the code below
1. Save your pipeline and run it using __Build Now__
1. You can see on the left the first build it will be called #1
1. Click on the build number and then select __Console Output__

```groovy
pipeline {
    agent any
    stages {
        stage("Hello") {
            steps {
                echo "Hello World"
            }
        }
    }
}
```

There are 2 styles of Groovy scripting you might see. The declarative style (used above) or the plain script style which looks more like this: 

```groovy
node {
    // commands
}
```

Can you update the script to print out the working directory of the jenkins agent? You will need to update the script which you can access again in __Configure__.

```
pipeline {
    agent any
    stages {
        stage("Hello") {
            steps {
                echo "Hello World"
            }
        }
        stage("PWD") {
            steps {
                sh "pwd"
            }
        }
    }
}
```
Above you can see that we have added another stage, and we are executing shell commands in a linux environment, we are not on our own file system we are inside an agent.

![Jenkins Agents](https://miro.medium.com/max/1400/1*RXh0nHJm_NXWW9KidWOsNA.webp)

Jenkins is central control. That is where we program pipelines, organise our pipelines and monitor them. The actual work of cloning repos, building apps etc is all done on agents. This are agent instances, they can be other nodes (other computers) and we can define them and what software they have installed upon them.

## Source Control Management

The next step we want to take is being able to pull a project from source control and start to work with it. Can you create a pipeline that pulls the moodtracker project and lists all the files with the `ls -l` command.

For Jenkins to pull and push to your repo it will need your bitbucket logins. You can avoid using your bit bucket password by generating an access token. If you goto your personal setting, you will see __App passwords__ You can create one for Jenkins. Add your credentials to Jenkins:

Dashboard -> Manage Jenkins -> Manage Credentials -> System -> Global credentials (unrestricted) -> + Add Credentials -> Username with Password

Now try to use them in a pipeline script

```groovy
pipeline {
    agent any
    stages {
        stage("clone") {
            steps {
                git credentialsId: 'YOUR_ID', url: 'https://bitbucket.org/bernardmordan/spring-oauth-example/src/master/'
                sh 'ls -l'
            }
        }
    }
}
```
Can you check out a branch? What happens if you try to run the tests with `gradle test`?

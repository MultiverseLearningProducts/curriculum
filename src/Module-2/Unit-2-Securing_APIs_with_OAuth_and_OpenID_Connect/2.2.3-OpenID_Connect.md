# OpenID Connect

## Learning Objectives
* Understand the difference between OAuth and OpenID Connect
* Know that Auth0 can store usernames and passwords on your behalf 
* Set up Auth0's universal login


## Lesson
OAuth deals specifically with <em>authorisation</em>. OpenID Connect (OIDC) is a protocol which is built on top of OAuth 2.0 and focusses on user <em>authentication</em>. It is widely used to enable user logins on websites and mobile apps.

![sequence diagram showing the OIDC authorization flow](https://user-images.githubusercontent.com/1316724/102927348-b8b75700-448e-11eb-9d0d-3d7fa4e6e1ea.png)

OIDC allows apps to verify the identity of the end user and obtain basic profile information such as name and email address. This profile information is held within another JWT known as the ID token.

> Use https://jwt.io to find out the name and email hidden in this JWT ID token `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkZyZWQgRmxpbnRzdG9uZSIsImVtYWlsIjoiZnJlZC5mbGludHN0b25lQHdoaXRlaGF0Lm9yZy51ayIsImlhdCI6MTUxNjIzOTAyMn0.DlHfHG2qZXpWszZv-X8LwoQkZUlqVgaXoRmnHXE2y_I`

## Implementing authentication using Auth0
In this lesson we will store our usernames and passwords in Auth0. This is not strictly necessary as Auth0 supports connecting to other datasources to vaidate credentials, however, doing so simplifies our implementation. 

### Adding usernames & passwords to Auth0
Navigate to `User Management->Users` and choose to `Create User`. Enter the credentials and click `Create`. Repeat for any other users you have. Note that Auth0 will take care of hashing the passwords for you.

### Creating a login page
Auth0's login page can be integrated into many different types of apps including mobile, single page apps and regular web apps. For this lesson we will choose to add login/logout functionality to a "regular web app". 

![Regular Web App Option on Auth0](https://user-images.githubusercontent.com/4499581/105991041-39273400-609b-11eb-9078-6975f7a5e2bc.png)

1. Using the Auth0 Dashboard, navigate to `Applications` and choose to `Create Application`. Choose `Regular Web Applications`.
1. Follow the wizard and select
    - Node.js(Express)
    - EXPLORE SAMPLE APP
    - SAVE AND DOWNLOAD APP
    This will create a new application called `My App` and download the code as a zip file
1. Extract the zip and import the code into VSCode
1. Edit the `.env` file to include your app specific settings (these will be visible in your Auth0 Dashboard under `Applications->My App`)
1. Add `.env` to your `.gitignore` to avoid details of your Auth0 account being saved to git.
1. Follow the instructions to start the sample application, then navigate to `http://localhost:3000/` - you should see the following web page.

    <img width="956" alt="generated sample app home page" src="https://user-images.githubusercontent.com/1316724/130907482-76adf6aa-db76-4dda-a722-e20f18ab3ec5.PNG">

1. Clicking "Login" will display the [Auth0 Universal Login](https://auth0.com/docs/universal-login) page

    <img width="246" alt="Auth0 universal login" src="https://user-images.githubusercontent.com/1316724/130907646-2c17c434-0a17-42c2-957e-e11c9360fd7b.PNG">

1. Enter the username and password you added to Auth0 and you should now be successfully logged in

    <img width="952" alt="loginCompleteOIDC" src="https://user-images.githubusercontent.com/1316724/130907911-d54c17a1-b9e7-4cb2-9691-10212bac5e35.PNG">

1. Select "Profile" to view your user profile information. This information is held in a JWT ID token called `req.oidc.user`.

    <img width="658" alt="Profile information" src="https://user-images.githubusercontent.com/1316724/130910094-1f29a94c-05e5-4ffb-8247-77445d5fea54.PNG">

Well done, you have successfully authenticated a user using OIDC!

## Assignment
In the previous lesson you used OAuth to secure your Messages API. In this lesson you used OIDC to implement user authentication and add login/logout functionality to a web app. Now we need to connect the two parts!

In this assignment you are required to extend your web app to call the Messages API.

[This documentation](https://github.com/auth0/express-openid-connect/blob/master/EXAMPLES.md#4-obtaining-access-tokens-to-call-external-apis) will help you obtain the necessary token.

Study HTTP calls

You also have a couple of middleware functions from the library to help protect all and individual routes. The library adds a [RequestContext](https://auth0.github.io/express-openid-connect/interfaces/requestcontext.html) object onto the `req` object in express. You can access the logged in user like this `req.oidc.user`. You can view their token like this `req.oidc.accessToken`. Below are two of the main functions in the library to get you going.

|middleware|purpose|
|:---------|:------|
|auth      |this adds `req.oidc` to all your requests|
|requiresAuth|use this to protect routes that require a user to be logged in|

```javascript
app.get('/profile', requiresAuth(), (req, res) => {
  res.send(req.oidc.user)
})

/**
{
    "nickname": "bernard.mordan",
    "name": "bernard.mordan@multiverse.io",
    "picture": "https://s.gravatar.com/avatar/52c5aa1584c1dc479342c603b30ff9e2?s=480&r=pg&d=https%3A%2F%2Fcdn.auth0.com%2Favatars%2Fbe.png",
    "updated_at": "2021-01-27T11:43:17.588Z",
    "email": "bernard.mordan@multiverse.io",
    "email_verified": false,
    "sub": "auth0|601151d59c2f080069ec8597"
}
*/
```

That last property the `sub` is a unique id number for that user. That might be useful...

## Summary

Below is the code to bootstrap a server that will use Auth0 to create, authenticate and manage authorization of users.

```javascript
const express = require('express')
const app = express()
const { sequelize } = require('./models')
const { auth } = require('express-openid-connect')

const openIDconfig = {
    authRequired: false,
    auth0Logout: true,
    secret: 'a long, randomly-generated string stored in env that you make up',
    baseURL: 'http://localhost:3000',
    clientID: YOUR_CLIENT_ID,
    issuerBaseURL: 'https://YOUR_AUTH0_DOMAIN.eu.auth0.com'
  }

app.use(express.json())
app.use(auth(openIDconfig))

// app.get('/login') this is created by express-openid-connect and displays a login widget
// app.get('/callback') this is created by express-openid-connect and fetches an authenticated user their token
// app.get('/logout') this is created by express-openid-connect and will end a users token based session

app.get('/', (req, res) => {
    res.send(req.oidc.user || "No user logged in")
})

app.listen(3000, () => {
    sequelize.sync().then(() => console.log("All ready for banking"))
})
```


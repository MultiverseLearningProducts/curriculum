<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <title> What is middleware?</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="shortcut icon" type="image/x-icon" href="/curriculum/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/an-old-hope.min.css">
        <link rel="stylesheet" href="/curriculum/style.css"/>
        <script src="/curriculum/js/highlight.min.js"></script>
        <script src="/curriculum/js/bash.min.js"></script>
        <script src="/curriculum/js/java.min.js"></script>
        <script src="/curriculum/js/javascript.min.js"></script>
        <script src="/curriculum/js/sql.min.js"></script>
    </head>
    <body>
        <button 
            id="navigation-toggle"
            aria-expanded="false"
            aria-haspopup="true"
            onclick="toggleNav()"
            onkeydown="event => {event.keyCode === 13 ? toggleNav() : null}"
            tabindex="1">Table of contents</button>
        <nav id="navigation"><ul><li><a href="/curriculum\Bootcamp/index.html">Bootcamp</a><ul><li><a href="/curriculum\Bootcamp\FAQ.html">FAQ</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming/index.html">Unit 1 Object Oriented Programming</a><ul><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.1-JavaScript_Objects_And_Functions.html">0.1.1 JavaScript Objects And Functions</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.2-Test_Driven_Development.html">0.1.2 Test Driven Development</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.3-Objects_in_an_Airport_Domain.html">0.1.3 Objects in an Airport Domain</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.4-Static_functions_and_properties.html">0.1.4 Static functions and properties</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.5-Inheritance.html">0.1.5 Inheritance</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.6-UML_Modelling.html">0.1.6 UML Modelling</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.7-Unit_1_Challenge.html">0.1.7 Unit 1 Challenge</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript/index.html">Unit 2 Asynchronous JavaScript</a><ul><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.1-Asynchronous_JavaScript.html">0.2.1 Asynchronous JavaScript</a></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.2-Asynchronous_Airport_Data_Load.html">0.2.2 Asynchronous Airport Data Load</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases/index.html">Unit 3 Relational Databases</a><ul><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.1-Logical_Data_Model.html">0.3.1 Logical Data Model</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.10-Sequelize_part_2.html">0.3.10 Sequelize part 2</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.2-Implementing_the_Logical_Data_Model.html">0.3.2 Implementing the Logical Data Model</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.3-Basic_SQL_Commands.html">0.3.3 Basic SQL Commands</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.4-SQL_Joins.html">0.3.4 SQL Joins</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.5-Database_access_using_Node.html">0.3.5 Database access using Node</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.6-Populating_databases_from_JSON.html">0.3.6 Populating databases from JSON</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.7-Object_Relational_Mapping_part_1.html">0.3.7 Object Relational Mapping part 1</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.8-Object_Relational_Mapping_part_2.html">0.3.8 Object Relational Mapping part 2</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.9-Sequelize_part_1.html">0.3.9 Sequelize part 1</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS/index.html">Unit 4 Advanced HTML CSS</a><ul><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.1-CSS_Fonts_and_Typography.html">0.4.1 CSS Fonts and Typography</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.1-CSS_Fundamentals.html">0.4.1 CSS Fundamentals</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.1-CSS_Positioning.html">0.4.1 CSS Positioning</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.2-CSS_Flexbox_Layout.html">0.4.2 CSS Flexbox Layout</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.4-Responsive_CSS_Media_Queries.html">0.4.4 Responsive CSS Media Queries</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.5-Responsive_CSS_Background_Images.html">0.4.5 Responsive CSS Background Images</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.6-Client_side_JavaScript.html">0.4.6 Client side JavaScript</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.6-HTML_Forms.html">0.4.6 HTML Forms</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.8-HTML_DOM_Events.html">0.4.8 HTML DOM Events</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.8-HTML_Web_Storage_API.html">0.4.8 HTML Web Storage API</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content/index.html">Unit 5 APIs and Dynamic Content</a><ul><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.1-Web_Servers.html">0.5.1 Web Servers</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.2-Application_Servers.html">0.5.2 Application Servers</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.3-Rendering_Dynamic_Content.html">0.5.3 Rendering Dynamic Content</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.4-Route_Parameters.html">0.5.4 Route Parameters</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.5-Server_side_Validation.html">0.5.5 Server side Validation</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.6-CRUD_operations.html">0.5.6 CRUD operations</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.7-Unit_5_Challenge.html">0.5.7 Unit 5 Challenge</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.8-Unit_5_Knowledge_Quiz.html">0.5.8 Unit 5 Knowledge Quiz</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-6-Website_Testing/index.html">Unit 6 Website Testing</a><ul><li><a href="/curriculum\Bootcamp\Unit-6-Website_Testing\0.6.1-Cypress_Testing.html">0.6.1 Cypress Testing</a></li><li><a href="/curriculum\Bootcamp\Unit-6-Website_Testing\0.6.2-Accessibility_Testing.html">0.6.2 Accessibility Testing</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project/index.html">Unit 7 End Of Bootcamp Group Project</a><ul><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.1-Introduction.html">0.7.1 Introduction</a></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.2-Requirements.html">0.7.2 Requirements</a></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.3-Agile_Development.html">0.7.3 Agile Development</a></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.4-Design.html">0.7.4 Design</a></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.5-GitHub_Projects.html">0.7.5 GitHub Projects</a></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.6-Branching_and_Pull_Requests.html">0.7.6 Branching and Pull Requests</a></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Group_Project\0.7.7-Deployment_with_Heroku.html">0.7.7 Deployment with Heroku</a></li></ul></li></ul></li><li><a href="/curriculum\Module-2/index.html">Module 2</a><ul><li><a href="/curriculum\Module-2\Unit-1-The_Anatomy_of_the_HTTP_request/index.html">Unit 1 The Anatomy of the HTTP request</a><ul><li><a href="/curriculum\Module-2\Unit-1-The_Anatomy_of_the_HTTP_request\2.1.1-Identifying_the_different_parts_of_HTTP.html">2.1.1 Identifying the different parts of HTTP</a></li><li><a href="/curriculum\Module-2\Unit-1-The_Anatomy_of_the_HTTP_request\2.1.2-Programmatic_HTTP_requests.html">2.1.2 Programmatic HTTP requests</a></li></ul></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST/index.html">Unit 2 What is REST</a><ul><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.1-REST_and_the_openAPI_spec.html">2.2.1 REST and the openAPI spec</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.2-The_OpenAPI_spec.html">2.2.2 The OpenAPI spec</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.3-Build_an_OpenAPI_RESTful_service.html">2.2.3 Build an OpenAPI RESTful service</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.4-Integration_tests.html">2.2.4 Integration tests</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.5-Unit_2_Knowledge_quiz.html">2.2.5 Unit 2 Knowledge quiz</a></li></ul></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography/index.html">Unit 3 Cryptography</a><ul><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.1-Hashing_Functions.html">2.3.1 Hashing Functions</a></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.2-Symmetric_Key_Encryption.html">2.3.2 Symmetric Key Encryption</a></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.3-Asymmetric_Key_Encryption.html">2.3.3 Asymmetric Key Encryption</a></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.4-Unit_3_Knowledge_Quiz.html">2.3.4 Unit 3 Knowledge Quiz</a></li></ul></li><li><a href="/curriculum\Module-2\Unit-4-Authentication/index.html">Unit 4 Authentication</a><ul><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.1-Authentication_and_Authorisation.html">2.4.1 Authentication and Authorisation</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.2-What_is_middleware.html">2.4.2 What is middleware</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.3-Session_based_auth.html">2.4.3 Session based auth</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.4-Introduction_to_OAuth.html">2.4.4 Introduction to OAuth</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.5-Token_based_auth.html">2.4.5 Token based auth</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.6-OpenID_Connect.html">2.4.6 OpenID Connect</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.7-Unit_4_Knowledge_Quiz.html">2.4.7 Unit 4 Knowledge Quiz</a></li></ul></li></ul></li><li><a href="/curriculum\Module-3/index.html">Module 3</a><ul><li><a href="/curriculum\Module-3\Unit-1-The-SDLC/index.html">Unit 1 The SDLC</a><ul><li><a href="/curriculum\Module-3\Unit-1-The-SDLC\3.1.1-Business_Impact.html">3.1.1 Business Impact</a></li></ul></li></ul></li></ul></nav>
        <h1>What is middleware?</h1>
<h2>Learning Objectives</h2>
<ul>
<li>Describe the middleware design pattern</li>
<li>Use what you have learnt in previous lessons to secure an API using Basic Auth</li>
</ul>
<h3>Lesson</h3>
<p>Your API should support a `User' resource. A user will need at least a name, email and password:</p>
<table>
<thead>
<tr><th>HTTP Method</th><th>URL</th><th>Status code</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td><code>/users</code></td><td>200</td><td>retrieve all users</td></tr>
<tr><td>POST</td><td><code>/users</code></td><td>201</td><td>create a new user</td></tr>
<tr><td>GET</td><td><code>/users/{id}</code></td><td>200</td><td>retrieve a specific user</td></tr>
<tr><td>PUT</td><td><code>/users/{id}</code></td><td>200</td><td>update a user</td></tr>
<tr><td>DELETE</td><td><code>/users/{id}</code></td><td>200</td><td>delete a user</td></tr>
</tbody>
</table>
<p>Our User resource in an unsecured state is just like any other resource like airports, training shoes or albums. However we are going to treat it differently.</p>
<p>To protect resources we need to authenticate the user making the request. We are using basic auth to do that by putting the <em>username:password</em> in the headers of the request.</p>
<p>Our server now needs to check the request is authentic and from a user it knows before responding. That check needs to happen before we respond.</p>
<p><figure><img src="https://miro.medium.com/max/960/1*Fnreje0WgqdBjjLXop9L0A.png" alt="middleware diagram"><figcaption></figcaption></figure></p>
<p>As that check happens in the middle of the request response cycle, it has been given the name of middleware. This is a generic design pattern you will see in many systems.</p>
<p>A whole series of things can happen in middleware not just authentication, but also authorisation. Thats why the diagram above has 2 middleware rings. There are 2 middlewares the request has to pass through before it gets to the controller. Below is a general pattern for a middleware function.</p>
<pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, response, next</span>) </span>{
  <span class="hljs-comment">// check or change something in the request</span>
  <span class="hljs-comment">// maybe its not ok so from here you might</span>
  <span class="hljs-keyword">return</span> response.code(<span class="hljs-number">403</span>) <span class="hljs-comment">// status code 403 forbidden</span>
  <span class="hljs-comment">// the controller was never reached!</span>
  <span class="hljs-comment">// maybe all is well and you can contiune with the request</span>
  <span class="hljs-comment">// calling next() finishes this middleware and goes onto</span>
  <span class="hljs-comment">// either the next middleware or into the controller/route handler itself</span>
  <span class="hljs-keyword">return</span> next()
}
</code></pre>
<p>❓ What other things might you want to do in middleware?</p>
<p>❓ is the password sent on every request or cached?</p>
<p>We are going to implement middlewares on our server. First of you need to authenticate the request and only accept requests from users your server knows about (the users in your database). We don't want any user to be able to see a list of all the other users, that is our authorisation rule.</p>
<h3>Assignment</h3>
<ul>
<li>Create an API which allows Create, Read, Update and Delete of a User using either SpringBoot or Node.js</li>
<li>Add sessions so authenticated users continue to have access to the <code>/users/:id</code> end point.</li>
<li>Enhance your API to check the incoming username and password against the details held in the database you created in the previous lesson</li>
<li>(Optional) Create a simple form which sends a username and password to your API using Basic Auth (i.e. simulates what Postman was doing in the previous lesson).</li>
</ul>
<p>Protect your Create, Read, Update and Delete user resources with Basic Authentication using the following code:</p>
<p>|Javascript|Java|</p>
<pre><code class="language-javascript"><span class="hljs-comment">// check for a basic auth header with correct credentials</span>
app.use(basicAuth({
  <span class="hljs-attr">authorizer</span>: dbAuthorizer, <span class="hljs-comment">// customer authorizer,</span>
  <span class="hljs-attr">authorizeAsync</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// we check the db which makes this async</span>
  <span class="hljs-attr">challenge</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">unauthorizedResponse</span>: <span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`unauthorized. ip: <span class="hljs-subst">${req.ip}</span>`</span>
  }
}));

<span class="hljs-comment">// our custom async authorizer middleware, this is called for each request</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dbAuthorizer</span>(<span class="hljs-params">username, password, callback</span>) </span>{
  <span class="hljs-keyword">const</span> sql = <span class="hljs-string">&quot;select password from users where username = ?;&quot;</span>;
  db.get(sql, [username], <span class="hljs-keyword">async</span> (err, user) =&gt; {
    err ? callback(err) : bcrypt.compare(password, user.password, callback);
  });
</code></pre>
<pre><code class="language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataSource dataSource;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">// do not use the line below in production apps!!</span>
        httpSecurity.csrf().disable(); <span class="hljs-comment">// hack to support DELETE method</span>
        httpSecurity.authorizeRequests().anyRequest().authenticated()
                .and().httpBasic();
    }

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureGlobal</span><span class="hljs-params">(AuthenticationManagerBuilder authentication)</span>
            <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">// use jdbc authentication (for in memory authentication use authentication.inMemoryAuthentication())</span>
        authentication.jdbcAuthentication()
                .dataSource(dataSource)
                .authoritiesByUsernameQuery(<span class="hljs-string">&quot;select username,authority &quot;</span>
                        + <span class="hljs-string">&quot;from authorities &quot;</span>
                        + <span class="hljs-string">&quot;where username = ?&quot;</span>)
                .usersByUsernameQuery(
                        <span class="hljs-string">&quot;select username, password, &#x27;true&#x27; as enabled from users where username = ?&quot;</span>);

    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// specify we want the password hashed using bcrypt</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
    }
}
</code></pre>

        <script src="/curriculum/js/tabbed-code-blocks.js"></script>
        <script>
            function toggleNav() {
                const button = document.getElementById('navigation-toggle')
                const isAriaExp = button.getAttribute('aria-expanded')
                const newAriaExp = (isAriaExp == "false") ? "true" : "false"
                button.setAttribute('aria-expanded', newAriaExp)
                const nav = document.getElementById('navigation')
                nav.style.display = nav.offsetParent ? 'none' : 'block'
            }
        </script>
    </body>
</html>
<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <title> Database access using Node.js</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="shortcut icon" type="image/x-icon" href="/curriculum/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/an-old-hope.min.css">
        <link rel="stylesheet" href="/curriculum/style.css"/>
        <script src="/curriculum/js/highlight.min.js"></script>
        <script src="/curriculum/js/bash.min.js"></script>
        <script src="/curriculum/js/java.min.js"></script>
        <script src="/curriculum/js/javascript.min.js"></script>
        <script src="/curriculum/js/sql.min.js"></script>
    </head>
    <body>
        <h1>Database access using Node.js</h1>
<h2>Learning Objectives</h2>
<ul>
<li>Connect to a SQL database using Node.js</li>
<li>Insert and manipulate data held in an SQL database using Node.js</li>
<li>Understand how Prepared Statements help to mitigate SQL Injection attacks</li>
</ul>
<h2>Pre-requisites</h2>
<ul>
<li><p>Familiarity with <a href="/curriculum/Bootcamp/Unit-2-Databases/0.2.1-Basic_SQL_Commands.html">Basic SQL Commands</a> and <a href="/curriculum/Bootcamp/Unit-2-Databases/0.2.2-SQL_Joins.html">SQL JOIN</a></p></li>
<li><p>Installation of the <code>sqlite</code> by <code>alexcvzz</code> plugin for VSCode. This will allow you to visualise your database. Once installed,</p>
<ol>
<li>Select <code>View-Command Palette</code> from the menu</li>
<li>Type <code>SQLite: Open Database</code> to select your database</li>
<li>A <code>SQLITE EXPLORER</code> window should appear at the bottom of your VSCode Explorer view displaying your tables.</li>
</ol></li>
<li><p>Installation of the SQLite node module. SQLite is a lightweight SQL database commonly used in embedded devices such as phones and games consoles. If you do not already have this installed please follow the instructions below:</p>
<ol>
<li><p>Create a new directory for this lesson's work. <code>cd</code> into it.</p></li>
<li><p>run <code>npm init</code> to create a new <code>package.json</code> file.</p></li>
<li><p>Execute <code>npm install sqlite3</code> in the directory where your <code>package.json</code> lives. If you get errors, try <code>npm install sqlite3@5.0.0</code> instead. If you still have errors, follow the instructions below (note these are Windows specific):</p>
<ul>
<li>Right click on VSCode and 'run as Administrator'. Navigate to the directory where your <code>package.json</code> file is and run <code>npm install --global --production windows-build-tools@4.0.0</code>.</li>
<li>Close VSCode and run it again (this time not as administrator i.e. just double click on the icon). Execute <code>npm install sqlite3@5.0.0</code> in the directory where your <code>package.json</code> lives.</li>
</ul></li>
</ol>
<p>To check your install is successful, paste the following code into a file named <code>dbconnect.js</code> and run the file with <code>node dbconnect.js</code>.</p></li>
</ul>
<pre><code class="language-js">    <span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;sqlite3&#x27;</span>).verbose();

    <span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> sqlite3.Database(<span class="hljs-string">&#x27;:memory:&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(err.message);
        }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Connected to the in-memory SQlite database.&#x27;</span>);
    });
  
    <span class="hljs-comment">// close the database connection</span>
    db.close(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.error(err.message);
        }
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Close the database connection.&#x27;</span>);
    });
</code></pre>
<h2>Lesson</h2>
<p>In this lesson we will save the database as a file written to our local disk rather than in-memory. This means that the data can be accessed even when our program has stopped running. We will interact with our database using JavaScript (Node.js).</p>
<p>The following Node.js code creates a RESTAURANT table in a database named 'restaurants.sqlite' and inserts a row into it:</p>
<pre><code class="language-js">const sqlite3 = require(&#x27;sqlite3&#x27;).verbose();

const db = new sqlite3.Database(&#x27;./restaurants.sqlite&#x27;);

try {
    db.serialize(function () { 

        db.run(&quot;CREATE TABLE RESTAURANT(id INTEGER PRIMARY KEY, 
                                        name TEXT, image TEXT&quot;);

        let stmt;

        try {
            stmt = db.prepare(`INSERT INTO Restaurants (id, name, link) VALUES 
                        (1, &#x27;Bayroot&#x27;, &#x27;https://www.telegraph.co.uk/content/dam/Travel/Destinations/Europe/England/Brighton/brighton-restaurants-hotel-du-vin-bistro.jpg&#x27;)`);
            stmt.run();
        } finally {
            // release resources 
            stmt.finalize();
        }

        // select the rows and print them out
        db.each(&quot;SELECT * FROM Restaurants&quot;,
            function (err, rows) {  
                console.log(rows);  
            }
        );
    });
} finally {
    // release resources 
    db.close();
}
</code></pre>
<p>Let's walk through the code step by step.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;sqlite3&#x27;</span>)
<span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> sqlite3.Database(<span class="hljs-string">&#x27;./db.sqlite&#x27;</span>)
</code></pre>
<p>In the lines above we import the <code>sqlite3</code> package then access a constructor on the <code>sqlite3</code> object and use the <code>new</code> keyword to instantiate a new instance of our database for our program. We can pass some config to our <code>Database</code> constructor, here we are passing in a relative path to where the database file either already exists, or where we would like it to be created and with what name.</p>
<p>The code uses a <a href="https://www.w3schools.com/jsref/jsref_try_catch.asp">try/finally</a> block to ensure that the statement and database are closed regardless of whether an error occurs. This is best practice to avoid memory leaks.</p>
<p>The code also makes use of <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">Prepared Statements</a> which are key for ensure your database applications are not vulnerable to <a href="https://portswigger.net/web-security/sql-injection">SQL injection attacks</a>. Watch this video to find out more about this kind of attack</p>
<p><iframe src="https://www.youtube.com/embed/wX6tszfgYp4" width="100%" height="444px" allowfullscreen frameborder=0></iframe></p>
<h2>Assignment</h2>
<ol>
<li>Write Node.js code to create a new, persistent database containing the tables described by the UML diagram in the <a href="/curriculum/Bootcamp/Unit-2-Databases/0.2.2-SQL_Joins.html">SQL Joins</a> lesson. Ensure you create FOREIGN KEYs as appropriate.</li>
<li>Write Node.js code to insert one row into the Restaurant table and ensure that this Restaurant has 2 Menus. Insert 2 Menu Items per Menu.</li>
<li>Write Node.js code to list all the Menu Items belonging to a specific Menu for the Restaurant.</li>
<li>Commit your code to GitHub and let you coach know it is ready for review</li>
</ol>
<h2>Assignment extension tasks</h2>
<ul>
<li>Research SQL injections attacks which made the news</li>
</ul>
<h2>Additional resources</h2>

        <script src="/curriculum/js/tabbed-code-blocks.js"></script>
    </body>
</html>
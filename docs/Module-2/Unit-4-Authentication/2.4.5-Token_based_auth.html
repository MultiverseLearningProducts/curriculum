<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <title> Token based Auth (OAuth)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="shortcut icon" type="image/x-icon" href="/curriculum/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/an-old-hope.min.css">
        <link rel="stylesheet" href="/curriculum/style.css"/>
        <script src="/curriculum/js/highlight.min.js"></script>
        <script src="/curriculum/js/bash.min.js"></script>
        <script src="/curriculum/js/java.min.js"></script>
        <script src="/curriculum/js/javascript.min.js"></script>
        <script src="/curriculum/js/sql.min.js"></script>
    </head>
    <body>
        <button 
            id="navigation-toggle"
            aria-expanded="false"
            aria-haspopup="true"
            onclick="toggleNav()"
            onkeydown="event => {event.keyCode === 13 ? toggleNav() : null}"
            tabindex="1">Table of contents</button>
        <nav id="navigation"><ul><li><a href="/curriculum/Bootcamp/index.html">Bootcamp</a><ul><li><a href="/curriculum/Bootcamp/FAQ.html">FAQ</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/index.html">Unit 1 Object Oriented Programming</a><ul><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.1-JavaScript_Objects_And_Functions.html">0.1.1 JavaScript Objects And Functions</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.2-Test_Driven_Development.html">0.1.2 Test Driven Development</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.3-Objects_in_an_Airport_Domain.html">0.1.3 Objects in an Airport Domain</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.4-Static_functions_and_properties.html">0.1.4 Static functions and properties</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.5-Inheritance.html">0.1.5 Inheritance</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.6-UML_Modelling.html">0.1.6 UML Modelling</a></li><li><a href="/curriculum/Bootcamp/Unit-1-Object_Oriented_Programming/0.1.7-Unit_1_Challenge.html">0.1.7 Unit 1 Challenge</a></li></ul></li><li><a href="/curriculum/Bootcamp/Unit-2-Asynchronous_JavaScript/index.html">Unit 2 Asynchronous JavaScript</a><ul><li><a href="/curriculum/Bootcamp/Unit-2-Asynchronous_JavaScript/0.2.1-Asynchronous_JavaScript.html">0.2.1 Asynchronous JavaScript</a></li><li><a href="/curriculum/Bootcamp/Unit-2-Asynchronous_JavaScript/0.2.2-Promises.html">0.2.2 Promises</a></li><li><a href="/curriculum/Bootcamp/Unit-2-Asynchronous_JavaScript/0.2.3-Asynchronous_Airport_Data_Load.html">0.2.3 Asynchronous Airport Data Load</a></li></ul></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/index.html">Unit 3 Relational Databases</a><ul><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.1-Logical_Data_Model.html">0.3.1 Logical Data Model</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.10-Sequelize_part_2.html">0.3.10 Sequelize part 2</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.2-Implementing_the_Logical_Data_Model.html">0.3.2 Implementing the Logical Data Model</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.3-Basic_SQL_Commands.html">0.3.3 Basic SQL Commands</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.4-SQL_Joins.html">0.3.4 SQL Joins</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.5-Database_access_using_Node.html">0.3.5 Database access using Node</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.6-Populating_databases_from_JSON.html">0.3.6 Populating databases from JSON</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.7-Object_Relational_Mapping_part_1.html">0.3.7 Object Relational Mapping part 1</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.8-Object_Relational_Mapping_part_2.html">0.3.8 Object Relational Mapping part 2</a></li><li><a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.9-Sequelize_part_1.html">0.3.9 Sequelize part 1</a></li></ul></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/index.html">Unit 4 RESTful Servers</a><ul><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.1-Web_Servers.html">0.4.1 Web Servers</a></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.2-Application_Servers.html">0.4.2 Application Servers</a></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.3-Postman.html">0.4.3 Postman</a></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.4-Route_Parameters.html">0.4.4 Route Parameters</a></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.5-CRUD_operations.html">0.4.5 CRUD operations</a></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.6-Server_side_Validation.html">0.4.6 Server side Validation</a></li><li><a href="/curriculum/Bootcamp/Unit-4-RESTful_Servers/0.4.7-Unit_5_Knowledge_Quiz.html">0.4.7 Unit 5 Knowledge Quiz</a></li></ul></li><li><a href="/curriculum/Bootcamp/Unit-5-Human_Computer_Interaction/index.html">Unit 5 Human Computer Interaction</a><ul><li><a href="/curriculum/Bootcamp/Unit-5-Human_Computer_Interaction/0.5.1-Human_Computer_Interaction.html">0.5.1 Human Computer Interaction</a></li><li><a href="/curriculum/Bootcamp/Unit-5-Human_Computer_Interaction/0.5.2-Server_Side_Rendering.html">0.5.2 Server Side Rendering</a></li><li><a href="/curriculum/Bootcamp/Unit-5-Human_Computer_Interaction/0.5.3-The_Document_Object_Model.html">0.5.3 The Document Object Model</a></li><li><a href="/curriculum/Bootcamp/Unit-5-Human_Computer_Interaction/0.5.4-HTML_forms_and_lists.html">0.5.4 HTML forms and lists</a></li></ul></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/index.html">Unit 6 End Of Bootcamp Group Project</a><ul><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.1-Introduction.html">0.6.1 Introduction</a></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.2-Requirements.html">0.6.2 Requirements</a></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.3-Agile_Development.html">0.6.3 Agile Development</a></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.4-Design.html">0.6.4 Design</a></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.5-GitHub_Projects.html">0.6.5 GitHub Projects</a></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.6-Branching_and_Pull_Requests.html">0.6.6 Branching and Pull Requests</a></li><li><a href="/curriculum/Bootcamp/Unit-6-End_Of_Bootcamp_Group_Project/0.6.7-Deployment_with_Heroku.html">0.6.7 Deployment with Heroku</a></li></ul></li></ul></li><li><a href="/curriculum/Module-1/index.html">Module 1</a><ul><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/index.html">Unit # Advanced HTML CSS</a><ul><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.1-CSS_Fonts_and_Typography.html">0.4.1 CSS Fonts and Typography</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.1-CSS_Fundamentals.html">0.4.1 CSS Fundamentals</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.1-CSS_Positioning.html">0.4.1 CSS Positioning</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.2-CSS_Flexbox_Layout.html">0.4.2 CSS Flexbox Layout</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.4-Responsive_CSS_Media_Queries.html">0.4.4 Responsive CSS Media Queries</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.5-Responsive_CSS_Background_Images.html">0.4.5 Responsive CSS Background Images</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.6-Client_side_JavaScript.html">0.4.6 Client side JavaScript</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.6-HTML_Forms.html">0.4.6 HTML Forms</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.8-HTML_DOM_Events.html">0.4.8 HTML DOM Events</a></li><li><a href="/curriculum/Module-1/Unit-#-Advanced_HTML_CSS/0.4.8-HTML_Web_Storage_API.html">0.4.8 HTML Web Storage API</a></li></ul></li></ul></li><li><a href="/curriculum/Module-2/index.html">Module 2</a><ul><li><a href="/curriculum/Module-2/Unit-1-The_Anatomy_of_the_HTTP_request/index.html">Unit 1 The Anatomy of the HTTP request</a><ul><li><a href="/curriculum/Module-2/Unit-1-The_Anatomy_of_the_HTTP_request/2.1.1-Identifying_the_different_parts_of_HTTP.html">2.1.1 Identifying the different parts of HTTP</a></li><li><a href="/curriculum/Module-2/Unit-1-The_Anatomy_of_the_HTTP_request/2.1.2-Programmatic_HTTP_requests.html">2.1.2 Programmatic HTTP requests</a></li></ul></li><li><a href="/curriculum/Module-2/Unit-2-What_is_REST/index.html">Unit 2 What is REST</a><ul><li><a href="/curriculum/Module-2/Unit-2-What_is_REST/2.2.1-REST_and_the_openAPI_spec.html">2.2.1 REST and the openAPI spec</a></li><li><a href="/curriculum/Module-2/Unit-2-What_is_REST/2.2.2-The_OpenAPI_spec.html">2.2.2 The OpenAPI spec</a></li><li><a href="/curriculum/Module-2/Unit-2-What_is_REST/2.2.3-Build_an_OpenAPI_RESTful_service.html">2.2.3 Build an OpenAPI RESTful service</a></li><li><a href="/curriculum/Module-2/Unit-2-What_is_REST/2.2.4-Integration_tests.html">2.2.4 Integration tests</a></li><li><a href="/curriculum/Module-2/Unit-2-What_is_REST/2.2.5-Unit_2_Knowledge_quiz.html">2.2.5 Unit 2 Knowledge quiz</a></li></ul></li><li><a href="/curriculum/Module-2/Unit-3-Cryptography/index.html">Unit 3 Cryptography</a><ul><li><a href="/curriculum/Module-2/Unit-3-Cryptography/2.3.1-Hashing_Functions.html">2.3.1 Hashing Functions</a></li><li><a href="/curriculum/Module-2/Unit-3-Cryptography/2.3.2-Symmetric_Key_Encryption.html">2.3.2 Symmetric Key Encryption</a></li><li><a href="/curriculum/Module-2/Unit-3-Cryptography/2.3.3-Asymmetric_Key_Encryption.html">2.3.3 Asymmetric Key Encryption</a></li><li><a href="/curriculum/Module-2/Unit-3-Cryptography/2.3.4-Unit_3_Knowledge_Quiz.html">2.3.4 Unit 3 Knowledge Quiz</a></li></ul></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/index.html">Unit 4 Authentication</a><ul><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.1-Authentication_and_Authorisation.html">2.4.1 Authentication and Authorisation</a></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.2-What_is_middleware.html">2.4.2 What is middleware</a></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.3-Session_based_auth.html">2.4.3 Session based auth</a></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.4-Introduction_to_OAuth.html">2.4.4 Introduction to OAuth</a></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.5-Token_based_auth.html">2.4.5 Token based auth</a></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.6-OpenID_Connect.html">2.4.6 OpenID Connect</a></li><li><a href="/curriculum/Module-2/Unit-4-Authentication/2.4.7-Unit_4_Knowledge_Quiz.html">2.4.7 Unit 4 Knowledge Quiz</a></li></ul></li></ul></li><li><a href="/curriculum/Module-3/index.html">Module 3</a><ul><li><a href="/curriculum/Module-3/Unit-1-The-SDLC/index.html">Unit 1 The SDLC</a><ul><li><a href="/curriculum/Module-3/Unit-1-The-SDLC/3.1.1-Business_Impact.html">3.1.1 Business Impact</a></li></ul></li><li><a href="/curriculum/Module-3/Unit-2-Website_Testing/index.html">Unit 2 Website Testing</a><ul><li><a href="/curriculum/Module-3/Unit-2-Website_Testing/0.6.1-Cypress_Testing.html">0.6.1 Cypress Testing</a></li><li><a href="/curriculum/Module-3/Unit-2-Website_Testing/0.6.2-Accessibility_Testing.html">0.6.2 Accessibility Testing</a></li></ul></li></ul></li></ul></nav>
        <h1>Token based Auth (OAuth)</h1>
<h2>Overview</h2>
<p>Today we are going to implement the Auth0 flow. We are then going to outsource our User accounts and authentication to Auth0. This is the day when we also start to plan for the final Module project.</p>
<h2>Learning Objectives</h2>
<ul>
<li>Use token based authorization to protect resources</li>
</ul>
<h2>Pre-requisites</h2>
<ul>
<li>An Auth0 account</li>
</ul>
<h1>Lesson 1 - Auth0</h1>
<p>In this lesson you will sign up to Auth0, a commercial implementation of OAuth, used by many well known companies including M&amp;S to secure their Web APIs.</p>
<ol>
<li><p>Go to https://auth0.com/signup</p></li>
<li><p>Use your personal email account, select your region as Europe and opt out of notifications. Ensure you create a PERSONAL account type.</p></li>
<li><p>Navigate to your Dashboard and select to <code>Create API</code> for your UsersAPI using the same details as below <figure><img src="https://user-images.githubusercontent.com/1316724/102825938-b2b26f00-43d7-11eb-8eb5-444ba240a13b.PNG" alt="Auth0 Users API" title="Users API"><figcaption>Users API</figcaption></figure></p></li>
<li><p>Navigate to the <code>Test</code> tab of your new API. You will see that a new application has been created called UsersAPI(Test Application) which is authorized to access the API.</p>
<p>You will see a section called <code>Asking Auth0 for tokens from my application</code>. Let's look in more detail at the parameters passed as part of the cURL request:</p>
<table>
<thead>
<tr><th>Element</th><th>Explanation</th></tr>
</thead>
<tbody>
<tr><td>audience</td><td>represents the resource which we are trying to access</td></tr>
<tr><td>grant_type</td><td>we are using <code>client_credentials</code> OAuth flow as we are making a machine -&gt; machine connection hence schemes like username + password or social logins don't make sense. You can read more about this flow <a href="https://auth0.com/docs/flows/client-credentials-flow">here</a>. If you are creating an SPA you should use the <a href="https://auth0.com/docs/flows/authorization-code-flow-with-proof-key-for-code-exchange-pkce">Authorization Code Flow with Proof Key for Code Exchange (PKCE)</a> instead (we will cover this later).</td></tr>
<tr><td>client_id</td><td>this is the id of the UsersAPI(Test Application) which is authorised to access the UsersAPI.</td></tr>
<tr><td>client_secret</td><td>this is the client secret of the UsersAPI(Test Application) which is authorised to access the UsersAPI.</td></tr>
</tbody>
</table>
</li>
<li><p>Use the information from the cURL request to help you construct a Postman request to obtain a new OAuth token.</p></li>
<li><p>You should see a 200 success status and the body of the response should contain an <code>access_token</code>. Paste it into the Debugger at https://jwt.io and explore the contents.</p>
<p>Common claims held within JWTs are:</p>
<ul>
<li>Issuer (iss)</li>
<li>Subject (sub)</li>
<li>Audience (aud)</li>
<li>Expiration time (exp)</li>
<li>Not before (nbf)</li>
<li>Issued at (iat)</li>
<li>JWT ID (jti)</li>
</ul></li>
</ol>
<h2>Securing your API with OAuth</h2>
<p>Open the Users API you created yesterday in Visual Code. This is currently secured using Basic Auth and we are going to modify it to be secured instead by OAuth.</p>
<p><strong>Coach note</strong> - solutions for JavaScript and Java at https://github.com/WhiteHatLearningProducts/swe-solutions/tree/main/mod1/users-api/oauthSecured/</p>
<h3>Javascript developers</h3>
<ol>
<li><p>Install the following node package dependencies:<br>
<code>npm install cors dotenv express-jwt jwks-rsa</code></p></li>
<li><p>Remove the dependency to <code>express-basic-auth</code></p></li>
<li><p>Add the following to the start of your <code>app.js</code> file as follows</p></li>
</ol>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-jwt&#x27;</span>);
<span class="hljs-keyword">const</span> jwksRsa = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jwks-rsa&#x27;</span>);
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cors&#x27;</span>); 

<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;dotenv&#x27;</span>).config(<span class="hljs-string">&#x27;.env&#x27;</span>); <span class="hljs-comment">// Note: env vars should not be used in production</span>
</code></pre>
<ol start="4">
<li>Add the following line AFTER the call to initialise Express</li>
</ol>
<pre><code class="language-javascript">app.use(cors());
</code></pre>
<ol start="5">
<li><p>Create a <code>.env</code> file and add the following entries (substituting in your personal Auth0 domain):</p>
<p><code>AUTH0_AUDIENCE=https://users</code></p>
<p><code>AUTH0_DOMAIN=[your domain].eu.auth0.com</code></p></li>
<li><p>Add a function to check for a valid OAuth (JWT) token:</p></li>
</ol>
<pre><code class="language-javascript"><span class="hljs-comment">// create middleware for checking the JWT</span>
<span class="hljs-keyword">const</span> checkJwt = jwt({
  <span class="hljs-attr">secret</span>: jwksRsa.expressJwtSecret({
    <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rateLimit</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">jwksRequestsPerMinute</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">jwksUri</span>: <span class="hljs-string">`https://<span class="hljs-subst">${process.env.AUTH0_DOMAIN}</span>.well-known/jwks.json`</span>
  }),
  <span class="hljs-attr">audience</span>: process.env.AUTH0_AUDIENCE,
  <span class="hljs-attr">issuer</span>: <span class="hljs-string">`https://<span class="hljs-subst">${process.env.AUTH0_DOMAIN}</span>`</span>,
  <span class="hljs-attr">algorithms</span>: [<span class="hljs-string">&#x27;RS256&#x27;</span>]
});

</code></pre>
<ol start="7">
<li>Secure your API:</li>
</ol>
<pre><code class="language-javascript">app.get(<span class="hljs-string">&quot;/users/:id&quot;</span>, checkJwt, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
</code></pre>
<h2>Java developers</h2>
<ol>
<li>Add the OAuth dependencies to your <code>pom.xml</code> file:</li>
</ol>
<pre><code class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        ...
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-security.version</span>&gt;</span>5.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">spring-security.version</span>&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-oauth2-resource-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-security.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-oauth2-jose<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-security.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-security.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li>Create a new class which checks that the JWT has the correct audience value</li>
</ol>
<pre><code class="language-java"><span class="hljs-keyword">import</span> org.springframework.security.oauth2.core.OAuth2Error;
<span class="hljs-keyword">import</span> org.springframework.security.oauth2.core.OAuth2TokenValidator;
<span class="hljs-keyword">import</span> org.springframework.security.oauth2.core.OAuth2TokenValidatorResult;
<span class="hljs-keyword">import</span> org.springframework.security.oauth2.jwt.Jwt;

<span class="hljs-comment">/**
 * Validates that the JWT is intended for our API.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AudienceValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OAuth2TokenValidator</span>&lt;<span class="hljs-title">Jwt</span>&gt; </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String audience;

    AudienceValidator(String audience) {
        <span class="hljs-keyword">this</span>.audience = audience;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2TokenValidatorResult <span class="hljs-title">validate</span><span class="hljs-params">(Jwt jwt)</span> </span>{
        OAuth2Error error = <span class="hljs-keyword">new</span> OAuth2Error(<span class="hljs-string">&quot;invalid_token&quot;</span>, <span class="hljs-string">&quot;The required audience is missing&quot;</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">if</span> (jwt.getAudience().contains(audience)) {
            <span class="hljs-keyword">return</span> OAuth2TokenValidatorResult.success();
        }
        <span class="hljs-keyword">return</span> OAuth2TokenValidatorResult.failure(error);
    }
}
</code></pre>
<ol start="3">
<li>Modifiy your SecurityConfiguration to use OAuth</li>
</ol>
<pre><code class="language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{

    <span class="hljs-meta">@Value(&quot;${auth0.audience}&quot;)</span>
    <span class="hljs-keyword">private</span> String audience;

    <span class="hljs-meta">@Value(&quot;${spring.security.oauth2.resourceserver.jwt.issuer-uri}&quot;)</span>
    <span class="hljs-keyword">private</span> String issuer;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        httpSecurity.authorizeRequests()
                .anyRequest()
                .authenticated()
                <span class="hljs-comment">// ** IMPORTANT! do not use the line below in production apps!! **</span>
                .and().csrf().disable()
                .and().cors()
                .and().oauth2ResourceServer().jwt();
    }

    <span class="hljs-comment">/**
     * Required to enable CORS - NOT suitable for production code!
     *
     * <span class="hljs-doctag">@return</span> CorsConfigurationSource cors configuration
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CorsConfigurationSource <span class="hljs-title">corsConfigurationSource</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">final</span> CorsConfiguration configuration = <span class="hljs-keyword">new</span> CorsConfiguration();

        <span class="hljs-comment">// ** IMPORTANT! do not use the line below in production apps!! **</span>
        <span class="hljs-comment">// ** Specify specific origins instead</span>
        configuration.setAllowedOriginPatterns(Arrays.asList(<span class="hljs-string">&quot;*&quot;</span>));
        configuration.setAllowedMethods(Arrays.asList(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;PUT&quot;</span>, <span class="hljs-string">&quot;DELETE&quot;</span>));
        configuration.setAllowCredentials(<span class="hljs-keyword">true</span>);
        configuration.setAllowedHeaders(Arrays.asList(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Cache-Control&quot;</span>, <span class="hljs-string">&quot;Content-Type&quot;</span>));

        <span class="hljs-keyword">final</span> UrlBasedCorsConfigurationSource source = <span class="hljs-keyword">new</span> UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration(<span class="hljs-string">&quot;/**&quot;</span>, configuration);

        <span class="hljs-keyword">return</span> source;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function">JwtDecoder <span class="hljs-title">jwtDecoder</span><span class="hljs-params">()</span> </span>{
        NimbusJwtDecoder jwtDecoder = (NimbusJwtDecoder)
                JwtDecoders.fromOidcIssuerLocation(issuer);

        OAuth2TokenValidator&lt;Jwt&gt; audienceValidator = <span class="hljs-keyword">new</span> AudienceValidator(audience);
        OAuth2TokenValidator&lt;Jwt&gt; withIssuer = JwtValidators.createDefaultWithIssuer(issuer);
        OAuth2TokenValidator&lt;Jwt&gt; withAudience = <span class="hljs-keyword">new</span> DelegatingOAuth2TokenValidator&lt;&gt;(withIssuer, audienceValidator);

        jwtDecoder.setJwtValidator(withAudience);

        <span class="hljs-keyword">return</span> jwtDecoder;
    }
}
</code></pre>
<ol start="4">
<li>Add a new file <code>application.yml</code> under <code>src/main/resources</code> to specify your Auth0 domain and audience</li>
</ol>
<pre><code class="language-xml">auth0:your Auth
  audience: https://users
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: https://[your Auth0 domain].eu.auth0.com/
</code></pre>
<h3>Secured</h3>
<p>Now test your middleware. You should not be able to access <code>/users/:id</code>. You will get a status code of 401 and a message about 'UnauthorizedError: No authorization token was found'.</p>
<p>Now we need to get our token. At the moment we are authenticating our users in the <code>/login</code> route and adding their id to <code>req.session.userId</code>. Instead of adding an authenticated user to a session we are going to call out to Auth0.com and request a token. We'll then send this token back to the user.</p>
<p>You can use <a href="https://npmjs.com/node-fetch">node-fetch</a> to make the request, the body of the POST request you can find on the Auth0 'Test' tab. It should look something like this:</p>
<p><em>YOUR_CLIENT_ID below needs to be replaced with the value in the example body from the Auth0 'Test' tab, same with YOUR_CLIENT_SECRET</em></p>
<pre><code class="language-javascript"><span class="hljs-comment">// user is Authenticated - Get a token</span>
<span class="hljs-keyword">const</span> auth0Config = {
    <span class="hljs-attr">client_id</span>: YOUR_CLIENT_ID,
    <span class="hljs-attr">client_secret</span>: YOUR_CLIENT_SECRET,
    <span class="hljs-attr">audience</span>: <span class="hljs-string">&#x27;http://localhost:3000/&#x27;</span>,
    <span class="hljs-attr">grant_type</span>: <span class="hljs-string">&#x27;client_credentials&#x27;</span>
}
<span class="hljs-keyword">const</span> {access_token} = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">&#x27;https://dev-7954hoz9.eu.auth0.com/oauth/token&#x27;</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-built_in">JSON</span>.stringify(auth0Config)
}).then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.json())

res.send(access_token)
</code></pre>
<h3>Calling your API</h3>
<ol>
<li><p>Once you user has called <code>/login</code> and obtain an Auth0 token</p></li>
<li><p>Call <code>/users/:id</code> with an <code>Authorization</code> header that uses a <code>Bearer Token</code> set to this token. Hopefully you should see a 200 OK response! See below for an example (this is generated by Postman).</p></li>
</ol>
<pre><code class="language-json">{
    <span class="hljs-attr">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Ijk3ZFlFdUxYTmNQRkxYRXdZc0JwLSJ9.eyJpc3MiOiJodHRwczovL2Rldi03OTU0aG96OS5ldS5hdXRoMC5jb20vIiwic3ViIjoiaHg4YVBnMEw2UmFESGZ6cjRzTUJINkliWWo1Nkg3WGtAY2xpZW50cyIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MzAwMS8iLCJpYXQiOjE2MTE3NDE5NTgsImV4cCI6MTYxMTgyODM1OCwiYXpwIjoiaHg4YVBnMEw2UmFESGZ6cjRzTUJINkliWWo1Nkg3WGsiLCJndHkiOiJjbGllbnQtY3JlZGVudGlhbHMifQ.FIDcKqc0AK0cj8K4PVvhmkRe7JSJhFVQMPsg9G5N7au8mN0J7ZcnMmL6UFADB1g3mXMWg_FttPOxF3KwvA8ylO3TAkHWKl-V5yY1akvaUNHfgV7lAhMpVMov_B9VRVecZR5AEImXDbcTDWcTIaa92AXos4RxXHjUhhbgJdCt50dL4F3QwA9WLiEfu72XOUId9_o1zRyvY7fSdsV9v1g2hdDWC1EmMVxSBsULxw98Rna0zNUlH66P0CJTqsnN3Z0qU-7ouRPNJZThQwBVHWtMqBTedibxq1ZxJGfYONlD-L-_gprxZmFv0wCQAJGgM8jkJym3OjYPdA7tavJbs2jQWA&quot;</span>
}
</code></pre>
<p>‚ùì How is this different from the Basic Auth that we have been using?</p>
<h2>Assignment</h2>
<p>Implement token based authorization using Auth0 as a token provider.</p>
<ol>
<li>Authenticate on https://Auth0.com</li>
<li>Create a new API</li>
<li>Update your express server with the jwtCheck middleware function</li>
<li>Goto the 'Test' tab on your Auth0 API Page and use the settings in the example request</li>
<li>Once your user is authenticated in the /login route - Get a token from Auth0 and send it back to your user</li>
<li>Verify everything is secure and working ok you should not be able to access the /users/:id route without a token</li>
</ol>

        <script src="/curriculum/js/tabbed-code-blocks.js"></script>
        <script>
            function toggleNav() {
                const button = document.getElementById('navigation-toggle')
                const isAriaExp = button.getAttribute('aria-expanded')
                const newAriaExp = (isAriaExp == "false") ? "true" : "false"
                button.setAttribute('aria-expanded', newAriaExp)
                const nav = document.getElementById('navigation')
                nav.style.display = nav.offsetParent ? 'none' : 'block'
            }
        </script>
    </body>
</html>
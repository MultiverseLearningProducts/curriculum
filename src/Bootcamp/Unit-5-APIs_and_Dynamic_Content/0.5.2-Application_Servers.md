# Application Servers

## Learning Objectives
* Build an application server serving dynamic content using [Node.js Express](https://expressjs.com/)  
* Understand the difference between static and dynamic content
* Create dynamic content using the Handlebars templating framework

## Pre-requisites
TODO

## Lesson
What makes content static? <b>Static</b> content is usually read from disc, it is the <em>same</em> on every request, it is the same for everyone. Examples include, image files, `.mp3` files and HTML files. We have been working with static files so far on our web server.

<b>Dynamic content</b> is content that can <em>change</em> from request to request, and might be different for different people. For example, everyone has the same basic Twitter page, but each person's page is filled with content that is particular to them. What is shared between users is the page's template. The content is changeable or dynamic.

![dynamic content on twitter page](https://user-images.githubusercontent.com/1316724/113910233-7fea8600-97d0-11eb-96fb-226c84b4ceef.jpg)

So where does the dynamic content come from? Dynamic content is usually stored in a database or comes from another service. The app responds to a request by fetching some specific content for that user/request and parses that content with a template to create the resulting HTML. The page is built per request 'on-the-fly' and is assembled by our app.

If we are serving dynamic content, our server is now called an <b>application server</b>.

### Creating a Route
The way we intercept or 'handle' HTTP requests is by declaring a 'route' (also known as a REST API endpoint) in our `server.js` file. 

TODO - add REST info

Here is an example route which returns the current date when the user navigates to the root endpoint.

```javascript
app.get('/', (request, response) => {
    const date = new Date()
    response.send(date)})
```
Route definitions appear <em>after</em> setting config with `app.use`, but <em>before</em> the call to `app.listen`. 

**Important** - Make sure you remove the `public/index.html` file to avoid it interfering with your `/` route.

### Creating a Template
Our dynamic content is going to be driven by a Restaurant data model. We want to display a list of restaurants within a web page. To do this, we are going to use a templating framework called [Handlebars](https://handlebarsjs.com/). This is a well supported template library in which you write HTML and use placeholders for dynamic content. 

A Handlebars expression is content surrounded by `{{` `}}`. When the template is executed, the expression is replaced with values from an input object. 

Handlebars expects a specific folder structure:
```sh

views
├── restaurants.handlebars
└── layouts
    └── main.handlebars

```
The `views` folder contains Handlebars templates which get rendered into `layouts`. 

A `layout` is an HTML page with a `{{{body}}}` placeholder into which views are rendered. The `layouts` folder typically holds a default `main.handlebars` layout. 

In our Restaurants app we will set the `main.handlebars` layout as follows: 
```html
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="/style.css"/>
    </head>
    <body>
        {{{body}}}
    </body>
</html>
```
The `restaurants.handlebars` file will be rendered in the `main.handlebars` layout  and for now, will simply print out the date. 
```html
<h1>Restaurants</h1>
<small>{{date}}</small>
```

We install Handlebars by running 
> `npm install handlebars express-handlebars @handlebars/allow-prototype-access`

Once installed, we can `require` it and set it as the templating engine to use in our Express code. 

```javascript
const express = require('express');
const Handlebars = require('handlebars')
const expressHandlebars = require('express-handlebars')
const {allowInsecurePrototypeAccess} = require('@handlebars/allow-prototype-access')

const app = express();
const port = 3000;

// setup our templating engine
const handlebars = expressHandlebars({
    handlebars: allowInsecurePrototypeAccess(Handlebars)
})
app.engine('handlebars', handlebars)
app.set('view engine', 'handlebars')

// serve static assets from the public/ folder
app.use(express.static('public'));

// this route matches any GET request to the top level URL
app.get('/', (request, response) => {
    response.render('restaurants', {date: new Date()})
})

app.listen(port, () => {
    console.log(`Server listening at http://localhost:${port}`)
})
```

The first argument to `response.render` is the name of the view template we want to render. In this example, this refers to a file named `restaurants.handlebars`.
The second argument to `response.render` is the dynamic data which will be passed to the view template.

## Assignment
  1. Install Handlebars as a Node dependency in your existing project

  1. Modify your `server.js` file to serve both static and dynamic content as per the code above. Start your server by navigating to `http://localhost:3000`. You should see the date displayed. Use 'Chrome Developer Tools' to see the HTTP requests as you refresh the page.

  1. Create another template in the `views` folder for an `about.handlebars` page. Add some static text for the page and a placeholder for a string holding the name of the website author.

  1. Create another route handler on your server, `/about`. When the user navigates to this URL, the Express route should render the `about.handlebars` page and pass in your name as the website author.

  1. Add a link from the `restaurants` page to the `about` page

  1. Commit your code into Github and share the link with your coach for review

  ### Assignment extension tasks
  Read the [Handlebars documentation](https://handlebarsjs.com/guide/#what-is-handlebars) to learn more about Handlebars expressions.

  ## Additional resources
   * [Get started with Express Handlebars](https://www.youtube.com/watch?v=erfN7fH7A6s) 
   * [Create default Layout - Express Handlebars](https://www.youtube.com/watch?v=Yh5qW_L5YNQ)



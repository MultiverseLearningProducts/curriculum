<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <title> Populating databases from JSON</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="shortcut icon" type="image/x-icon" href="/curriculum/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/an-old-hope.min.css">
        <link rel="stylesheet" href="/curriculum/style.css"/>
        <script src="/curriculum/js/highlight.min.js"></script>
        <script src="/curriculum/js/bash.min.js"></script>
        <script src="/curriculum/js/java.min.js"></script>
        <script src="/curriculum/js/javascript.min.js"></script>
        <script src="/curriculum/js/sql.min.js"></script>
    </head>
    <body>
        <button 
            id="navigation-toggle"
            aria-expanded="false"
            aria-haspopup="true"
            onclick="toggleNav()"
            onkeydown="event => {event.keyCode === 13 ? toggleNav() : null}"
            tabindex="1">Table of contents</button>
        <nav id="navigation"><ul><li><a href="/curriculum\Bootcamp/index.html">Bootcamp</a><ul><li><a href="/curriculum\Bootcamp\FAQ.html">FAQ</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming/index.html">Unit 1 Object Oriented Programming</a><ul><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.1-JavaScript_Objects_And_Functions.html">0.1.1 JavaScript Objects And Functions</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.2-Test_Driven_Development.html">0.1.2 Test Driven Development</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.3-Objects_in_an_Airport_Domain.html">0.1.3 Objects in an Airport Domain</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.4-Static_functions_and_properties.html">0.1.4 Static functions and properties</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.5-Inheritance.html">0.1.5 Inheritance</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.6-UML_Modelling.html">0.1.6 UML Modelling</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.7-Scooter_Hire_System.html">0.1.7 Scooter Hire System</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript/index.html">Unit 2 Asynchronous JavaScript</a><ul><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.1-Asynchronous_JavaScript.html">0.2.1 Asynchronous JavaScript</a></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.2-Asynchronous_Airport_Data_Load.html">0.2.2 Asynchronous Airport Data Load</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases/index.html">Unit 3 Relational Databases</a><ul><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.1-Logical_Data_Model.html">0.3.1 Logical Data Model</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.10-Sequelize_part_2.html">0.3.10 Sequelize part 2</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.2-Implementing_the_Logical_Data_Model.html">0.3.2 Implementing the Logical Data Model</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.3-Basic_SQL_Commands.html">0.3.3 Basic SQL Commands</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.4-SQL_Joins.html">0.3.4 SQL Joins</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.5-Database_access_using_Node.html">0.3.5 Database access using Node</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.6-Populating_databases_from_JSON.html">0.3.6 Populating databases from JSON</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.7-Object_Relational_Mapping_part_1.html">0.3.7 Object Relational Mapping part 1</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.8-Object_Relational_Mapping_part_2.html">0.3.8 Object Relational Mapping part 2</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.9-Sequelize_part_1.html">0.3.9 Sequelize part 1</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS/index.html">Unit 4 Advanced HTML CSS</a><ul><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.1-CSS_Box_Model.html">0.4.1 CSS Box Model</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.1-CSS_Fundamentals.html">0.4.1 CSS Fundamentals</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.1-CSS_Positioning.html">0.4.1 CSS Positioning</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.2-CSS_Flexbox_Layout.html">0.4.2 CSS Flexbox Layout</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.3-CSS_Grid_Layout.html">0.4.3 CSS Grid Layout</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.4-Responsive_CSS_Media_Queries.html">0.4.4 Responsive CSS Media Queries</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.5-Responsive_CSS_Background_Images.html">0.4.5 Responsive CSS Background Images</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.6-Client_side_JavaScript.html">0.4.6 Client side JavaScript</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.6-HTML_Forms.html">0.4.6 HTML Forms</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.8-HTML_DOM_Events.html">0.4.8 HTML DOM Events</a></li><li><a href="/curriculum\Bootcamp\Unit-4-Advanced_HTML_CSS\0.4.8-HTML_Web_Storage_API.html">0.4.8 HTML Web Storage API</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content/index.html">Unit 5 APIs and Dynamic Content</a><ul><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.1-Web_Servers.html">0.5.1 Web Servers</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.2-Application_Servers.html">0.5.2 Application Servers</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.3-Rendering_Dynamic_Content.html">0.5.3 Rendering Dynamic Content</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.4-Route_Parameters.html">0.5.4 Route Parameters</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.5-Server_side_Validation.html">0.5.5 Server side Validation</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.6-CRUD_operations.html">0.5.6 CRUD operations</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.7-Full_CRUD_operations.html">0.5.7 Full CRUD operations</a></li><li><a href="/curriculum\Bootcamp\Unit-5-APIs_and_Dynamic_Content\0.5.8-Restaurant_ratings.html">0.5.8 Restaurant ratings</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-6-Website_Testing/index.html">Unit 6 Website Testing</a><ul><li><a href="/curriculum\Bootcamp\Unit-6-Website_Testing\0.6.1-Cypress_Testing.html">0.6.1 Cypress Testing</a></li><li><a href="/curriculum\Bootcamp\Unit-6-Website_Testing\0.6.2-Accessibility_Testing.html">0.6.2 Accessibility Testing</a></li></ul></li><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Assessment/index.html">Unit 7 End Of Bootcamp Assessment</a><ul><li><a href="/curriculum\Bootcamp\Unit-7-End_Of_Bootcamp_Assessment\0.7.1-TODO.html">0.7.1 TODO</a></li></ul></li></ul></li><li><a href="/curriculum\Module-2/index.html">Module 2</a><ul><li><a href="/curriculum\Module-2\Unit-1-The_Anatomy_of_the_HTTP_request/index.html">Unit 1 The Anatomy of the HTTP request</a><ul><li><a href="/curriculum\Module-2\Unit-1-The_Anatomy_of_the_HTTP_request\2.1.1-Identifying_the_different_parts_of_HTTP.html">2.1.1 Identifying the different parts of HTTP</a></li><li><a href="/curriculum\Module-2\Unit-1-The_Anatomy_of_the_HTTP_request\2.1.2-Programmatic_HTTP_requests.html">2.1.2 Programmatic HTTP requests</a></li></ul></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST/index.html">Unit 2 What is REST</a><ul><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.1-REST_and_the_openAPI_spec.html">2.2.1 REST and the openAPI spec</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.2-The_OpenAPI_spec.html">2.2.2 The OpenAPI spec</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.3-Build_an_OpenAPI_RESTful_service.html">2.2.3 Build an OpenAPI RESTful service</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.4-Integration_tests.html">2.2.4 Integration tests</a></li><li><a href="/curriculum\Module-2\Unit-2-What_is_REST\2.2.5-Unit_2_Knowledge_quiz.html">2.2.5 Unit 2 Knowledge quiz</a></li></ul></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography/index.html">Unit 3 Cryptography</a><ul><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.1-Hashing_Functions.html">2.3.1 Hashing Functions</a></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.2-Symmetric_Key_Encryption.html">2.3.2 Symmetric Key Encryption</a></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.3-Asymmetric_Key_Encryption.html">2.3.3 Asymmetric Key Encryption</a></li><li><a href="/curriculum\Module-2\Unit-3-Cryptography\2.3.4-Unit_3_Knowledge_Quiz.html">2.3.4 Unit 3 Knowledge Quiz</a></li></ul></li><li><a href="/curriculum\Module-2\Unit-4-Authentication/index.html">Unit 4 Authentication</a><ul><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.1-Authentication_and_Authorisation.html">2.4.1 Authentication and Authorisation</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.2-What_is_middleware.html">2.4.2 What is middleware</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.3-Session_based_auth.html">2.4.3 Session based auth</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.4-Introduction_to_OAuth.html">2.4.4 Introduction to OAuth</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.5-Token_based_auth.html">2.4.5 Token based auth</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.6-OpenID_Connect.html">2.4.6 OpenID Connect</a></li><li><a href="/curriculum\Module-2\Unit-4-Authentication\2.4.7-Unit_4_Knowledge_Quiz.html">2.4.7 Unit 4 Knowledge Quiz</a></li></ul></li></ul></li><li><a href="/curriculum\Module-3/index.html">Module 3</a><ul><li><a href="/curriculum\Module-3\Unit-1-The-SDLC/index.html">Unit 1 The SDLC</a><ul><li><a href="/curriculum\Module-3\Unit-1-The-SDLC\3.1.1-Business_Impact.html">3.1.1 Business Impact</a></li></ul></li></ul></li></ul></nav>
        <h1>Populating databases from JSON</h1>
<h2>Learning Objectives</h2>
<p>How to use JavaScript (Node.js) to load data from a JSON file and populate database tables.</p>
<h2>Pre-requisites</h2>
<ul>
<li><p>Familiarity with <a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.5-Database_access_using_Node.html">Database access using Node.js</a></p></li>
<li><p>Download this <a href="https://raw.githubusercontent.com/MultiverseLearningProducts/airports/master/airportsData.json">airports.json</a> file</p></li>
</ul>
<h2>Lesson</h2>
<p>The airport data you downloaded is called &quot;seed&quot; data. The data is in a <a href="https://www.w3schools.com/js/js_json_intro.asp">JSON</a> format.</p>
<p>Here is a representation of a an Airport object from the JSON data:</p>
<pre><code class="language-json">{
  <span class="hljs-attr">&quot;icao&quot;</span>: <span class="hljs-string">&quot;KPAE&quot;</span>,
  <span class="hljs-attr">&quot;iata&quot;</span>: <span class="hljs-string">&quot;PAE&quot;</span>,
  <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;Snohomish County (Paine Field) Airport&quot;</span>,
  <span class="hljs-attr">&quot;city&quot;</span>: <span class="hljs-string">&quot;Everett&quot;</span>,
  <span class="hljs-attr">&quot;state&quot;</span>: <span class="hljs-string">&quot;Washington&quot;</span>,
  <span class="hljs-attr">&quot;country&quot;</span>: <span class="hljs-string">&quot;US&quot;</span>,
  <span class="hljs-attr">&quot;elevation&quot;</span>: <span class="hljs-number">606</span>,
  <span class="hljs-attr">&quot;lat&quot;</span>: <span class="hljs-number">47.90629959</span>,
  <span class="hljs-attr">&quot;lon&quot;</span>: <span class="hljs-number">-122.2819977</span>,
  <span class="hljs-attr">&quot;tz&quot;</span>: <span class="hljs-string">&quot;America/Los_Angeles&quot;</span>
}
</code></pre>
<p>Key points to note are that:</p>
<ul>
<li>JSON objects are surrounded by curly braces {}</li>
<li>JSON objects are written in key/value pairs</li>
<li>JSON arrays are implemented with <code>[]</code> syntax</li>
<li>Keys and values are separated by a colon</li>
<li>Each key-value pair is separated by a comma</li>
<li>Keys must be always be strings and values must be a valid JSON data type i.e. one of string, number, object, array, boolean or null</li>
</ul>
<p>Looking at the data helps us decide what column names and data types we need to set up in our database. This is called the database schema. What column names and data types do you think we will need to store the airport data?</p>
<p>Once we have figured out the schema, we need to compose a query that will create the AIRPORTS table if it does not already exist. We will want to run this <em>before</em> we read the data out of our file.</p>
<pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> airports(id <span class="hljs-type">INTEGER</span> PRIM...etc);
</code></pre>
<p>To insert the data into database tables, we need to firstly asychronously load the file, then iterate over the data and insert it using Prepared Statements. Before we do this, let's use the best practise of Test Driven Development (TDD) and write a unit test.</p>
<h3>Write a failing test</h3>
<p>Here is an example of a Jest test which uses the <code>beforeAll</code> method to initialise the database with our tables if they don't already exist. The idea of the failing test helps you think about what you are actually trying to build.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> load = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./index&#x27;</span>)

describe(<span class="hljs-string">&#x27;SQLite3&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
    beforeAll(<span class="hljs-function"><span class="hljs-params">done</span> =&gt;</span> {
        db.exec(<span class="hljs-string">&#x27;CREATE TABLE IF NOT EXISTS airports(...);&#x27;</span>, done)
    })
    test(<span class="hljs-string">&#x27;airports are loaded into the database&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> {
        load(<span class="hljs-function">(<span class="hljs-params">db</span>) =&gt;</span> {
            db.all(<span class="hljs-string">&#x27;SELECT * FROM airports LIMIT 3;&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, row</span>) =&gt;</span> {
                expect(row.length).toBe(<span class="hljs-number">3</span>)
                expect(row[<span class="hljs-number">0</span>].name).toBe(<span class="hljs-string">&#x27;Shenyang Dongta Airport&#x27;</span>)
                db.get(<span class="hljs-string">&#x27;SELECT COUNT(id) AS total FROM airports;&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, count</span>) =&gt;</span> {
                    expect(count.total).toBe(<span class="hljs-number">28868</span>)
                    done()
                })
            })
        })
    })
})
</code></pre>
<h3>Reading JSON data from a file using Node.js</h3>
<p>Reading from a file may take a long time hence it is performed asynchronously.</p>
<p>Here is one version of a <code>load()</code> method which makes use of <code>async</code>/<code>await</code> to load the data into a JavaScript array, you can also write this using Promises or Callbacks.</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> fsp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>).promises; <span class="hljs-comment">// Node.js file system module with promises</span>

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">load</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;calling load&#x27;</span>);
    <span class="hljs-comment">// wait for the file to be read</span>
    <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> fsp.readFile(<span class="hljs-string">&#x27;./airports.json&#x27;</span>);
    <span class="hljs-keyword">const</span> restaurants = (<span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">String</span>(buffer)));
    <span class="hljs-keyword">return</span> restaurants;
}
</code></pre>
<h3>Load the JSON data into database tables using Node.js</h3>
<p>Now we have the data loaded, we need to loop through the array of airports and use the airport object to form an SQL insert query.</p>
<p>We make use of <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">Prepared Statements</a> which are key for ensure your database applications are not vulnerable to <a href="https://portswigger.net/web-security/sql-injection">SQL injection attacks</a>.</p>
<pre><code class="language-SQL">db.prepare(&quot;INSERT INTO airports (icao, iata, name, city, state, country, elevation, lat, lon, tz) VALUES (?,?,?,?,?,?,?,?,?,?)&quot;);
</code></pre>
<p>All the &quot;?&quot; are placeholders for the different values that we will be inserting as we iterate over our array of data. When you call <code>db.run</code> the first argument is the string above, and the second argument is an array of all the values you want to store. The &quot;?&quot; are substituated with the data hence your values have to be in the same order as the database columns.</p>
<h2>Assignment</h2>
<ol>
<li><p>Create a <a href="/curriculum/Bootcamp/FAQ#createNewProject">new Node.js project</a> for this assignment.</p></li>
<li><p>Download this <a href="https://raw.githubusercontent.com/MultiverseLearningProducts/restaurant-data/master/restaurants.json">restaurant data file</a>.</p></li>
<li><p>Write a unit test to verify your seed data has loaded into the database ok. This will fail initially but should pass once you complete the rest of the assignment.</p></li>
<li><p>Create a js file (named <code>initialiseDB.js</code>) which contains Node.js code to create a new, persistent database containing the tables described by the UML diagram in the <a href="/curriculum/Bootcamp/Unit-3-Relational_Databases/0.3.4-SQL_Joins.html">SQL Joins</a> lesson. Ensure you create FOREIGN KEYs as appropriate.</p></li>
<li><p>Create a js file (named <code>populateDB.js</code>) which contains code to load the restaurant JSON data and recursively insert each Restaurant, Menu &amp; MenuItem into the database. You will be looping through a <a href="https://www.geeksforgeeks.org/multidimensional-array-in-javascript/">multi-dimensional array</a>. Remember to use <code>try/catch/finally</code> blocks to handle errors and close both the statements and database.</p></li>
<li><p>Commit your code into Github and share the link with your coach for review.</p></li>
</ol>
<h3>Assignment extension tasks</h3>
<ul>
<li>Add additional unit tests to simulate exception conditions such as the seed file not being found or the database table not existing.</li>
</ul>
<h2>Additional resources</h2>

        <script src="/curriculum/js/tabbed-code-blocks.js"></script>
        <script>
            function toggleNav() {
                const button = document.getElementById('navigation-toggle')
                const isAriaExp = button.getAttribute('aria-expanded')
                const newAriaExp = (isAriaExp == "false") ? "true" : "false"
                button.setAttribute('aria-expanded', newAriaExp)
                const nav = document.getElementById('navigation')
                nav.style.display = nav.offsetParent ? 'none' : 'block'
            }
        </script>
    </body>
</html>
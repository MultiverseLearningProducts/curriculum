<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="utf-8">
        <title> What is middleware?</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="shortcut icon" type="image/x-icon" href="/curriculum/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/an-old-hope.min.css">
        <link rel="stylesheet" href="/curriculum/style.css"/>
        <script src="/curriculum/js/highlight.min.js"></script>
        <script src="/curriculum/js/bash.min.js"></script>
        <script src="/curriculum/js/java.min.js"></script>
        <script src="/curriculum/js/javascript.min.js"></script>
        <script src="/curriculum/js/sql.min.js"></script>
    </head>
    <body>
        <button 
            id="navigation-toggle"
            aria-expanded="false"
            aria-haspopup="true"
            onclick="toggleNav()"
            onkeydown="event => {event.keyCode === 13 ? toggleNav() : null}"
            tabindex="1">Table of contents</button>
        <nav id="navigation"><ul><details><summary>Bootcamp</summary><ul><details><summary>Unit 1 Object Oriented Programming</summary><ul><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.0-UML_Modelling.html">0.1.0 UML Modelling</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.1-JavaScript_Objects_And_Functions.html">0.1.1 JavaScript Objects And Functions</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.2-Test_Driven_Development.html">0.1.2 Test Driven Development</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.3-Objects_in_an_Airport_Domain.html">0.1.3 Objects in an Airport Domain</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.4-Static_functions_and_properties.html">0.1.4 Static functions and properties</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.5-Inheritance.html">0.1.5 Inheritance</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.7-OOP_Challenge.html">0.1.7 OOP Challenge</a></li><li><a href="/curriculum\Bootcamp\Unit-1-Object_Oriented_Programming\0.1.8-End_of_Unit_Quiz_OOP.html">0.1.8 End of Unit Quiz OOP</a></li></ul></details><details><summary>Unit 2 Asynchronous JavaScript</summary><ul><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.1-Asynchronous_JavaScript.html">0.2.1 Asynchronous JavaScript</a></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.2-Promises.html">0.2.2 Promises</a></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.3-Asynchronous_Airport_Data_Load.html">0.2.3 Asynchronous Airport Data Load</a></li><li><a href="/curriculum\Bootcamp\Unit-2-Asynchronous_JavaScript\0.2.4-End_of_Unit_Quiz_Async.html">0.2.4 End of Unit Quiz Async</a></li></ul></details><details><summary>Unit 3 Relational Databases</summary><ul><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.10-Sequelize_part_2.html">0.3.10 Sequelize part 2</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.11-End_of_Unit_Quiz_Databases.html">0.3.11 End of Unit Quiz Databases</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.2-Introduction_to_Databases.html">0.3.2 Introduction to Databases</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.3-Basic_SQL_Commands.html">0.3.3 Basic SQL Commands</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.4-SQL_Joins.html">0.3.4 SQL Joins</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.5-Database_access_using_Node.html">0.3.5 Database access using Node</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.6-Populating_databases_from_JSON.html">0.3.6 Populating databases from JSON</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.7-Object_Relational_Mapping_part_1.html">0.3.7 Object Relational Mapping part 1</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.8-Object_Relational_Mapping_part_2.html">0.3.8 Object Relational Mapping part 2</a></li><li><a href="/curriculum\Bootcamp\Unit-3-Relational_Databases\0.3.9-Sequelize_part_1.html">0.3.9 Sequelize part 1</a></li></ul></details><details><summary>Unit 4 RESTful Servers</summary><ul><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.1-Web_Servers.html">0.4.1 Web Servers</a></li><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.2-Application_Servers.html">0.4.2 Application Servers</a></li><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.3-Postman.html">0.4.3 Postman</a></li><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.4-Route_Parameters.html">0.4.4 Route Parameters</a></li><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.5-CRUD_operations.html">0.4.5 CRUD operations</a></li><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.6-Server_side_Validation.html">0.4.6 Server side Validation</a></li><li><a href="/curriculum\Bootcamp\Unit-4-RESTful_Servers\0.4.7-End_of_Unit_Quiz_RESTful.html">0.4.7 End of Unit Quiz RESTful</a></li></ul></details><details><summary>Unit 5 Human Computer Interaction</summary><ul><li><a href="/curriculum\Bootcamp\Unit-5-Human_Computer_Interaction\0.5.1-Human_Computer_Interaction.html">0.5.1 Human Computer Interaction</a></li><li><a href="/curriculum\Bootcamp\Unit-5-Human_Computer_Interaction\0.5.2-Server_Side_Rendering.html">0.5.2 Server Side Rendering</a></li><li><a href="/curriculum\Bootcamp\Unit-5-Human_Computer_Interaction\0.5.3-The_Document_Object_Model.html">0.5.3 The Document Object Model</a></li><li><a href="/curriculum\Bootcamp\Unit-5-Human_Computer_Interaction\0.5.4-HTML_forms_and_lists.html">0.5.4 HTML forms and lists</a></li><li><a href="/curriculum\Bootcamp\Unit-5-Human_Computer_Interaction\0.5.5-End_of_Unit_Quiz_HCI.html">0.5.5 End of Unit Quiz HCI</a></li></ul></details><details><summary>Unit 6 End Of Bootcamp Group Project</summary><ul><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.1-Introduction.html">0.6.1 Introduction</a></li><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.2-Requirements.html">0.6.2 Requirements</a></li><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.3-Agile_Development.html">0.6.3 Agile Development</a></li><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.4-Design.html">0.6.4 Design</a></li><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.5-GitHub_Projects.html">0.6.5 GitHub Projects</a></li><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.6-Branching_and_Pull_Requests.html">0.6.6 Branching and Pull Requests</a></li><li><a href="/curriculum\Bootcamp\Unit-6-End_Of_Bootcamp_Group_Project\0.6.7-Deployment_with_Heroku.html">0.6.7 Deployment with Heroku</a></li></ul></details></ul></details><details><summary>Module 1</summary><ul><details><summary>Unit 1 Agile user requirements</summary><ul><li><a href="/curriculum\Module-1\Unit-1-Agile_user_requirements\1.1.1-Introduction_to_Agile.html">1.1.1 Introduction to Agile</a></li><li><a href="/curriculum\Module-1\Unit-1-Agile_user_requirements\1.1.2-Personas.html">1.1.2 Personas</a></li><li><a href="/curriculum\Module-1\Unit-1-Agile_user_requirements\1.1.3-User_Stories.html">1.1.3 User Stories</a></li><li><a href="/curriculum\Module-1\Unit-1-Agile_user_requirements\1.1.4-Requirements.html">1.1.4 Requirements</a></li><li><a href="/curriculum\Module-1\Unit-1-Agile_user_requirements\1.1.5-Next_Steps.html">1.1.5 Next Steps</a></li></ul></details><details><summary>Unit 2 Designing UI</summary><ul><li><a href="/curriculum\Module-1\Unit-2-Designing_UI\1.2.1-Usability_heuristics.html">1.2.1 Usability heuristics</a></li><li><a href="/curriculum\Module-1\Unit-2-Designing_UI\1.2.2-Composition_and_components_in_design.html">1.2.2 Composition and components in design</a></li><li><a href="/curriculum\Module-1\Unit-2-Designing_UI\1.2.3-Prototyping_UI.html">1.2.3 Prototyping UI</a></li><li><a href="/curriculum\Module-1\Unit-2-Designing_UI\1.2.4-Next_Steps.html">1.2.4 Next Steps</a></li></ul></details><details><summary>Unit 3 Building UI with React</summary><ul><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.0-Welcome_to_Unit_3.html">1.3.0 Welcome to Unit 3</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.1-Getting_started_with_React.html">1.3.1 Getting started with React</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.2-React_methods_and_computed_properties.html">1.3.2 React methods and computed properties</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.3-Events_and_adding_to_cart.html">1.3.3 Events and adding to cart</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.4-Introducing_routing_to_our_app.html">1.3.4 Introducing routing to our app</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.5-Fixing_the_add_to_cart_event.html">1.3.5 Fixing the add to cart event</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.6-Adding_the_product_details_page.html">1.3.6 Adding the product details page</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.7-Integrating_Redux_for_global_state_management.html">1.3.7 Integrating Redux for global state management</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.8-Consolidating_the_final_components.html">1.3.8 Consolidating the final components</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_React\1.3.9-Closing_thoughts_and_next_steps.html">1.3.9 Closing thoughts and next steps</a></li></ul></details><details><summary>Unit 3 Building UI with Vue.js</summary><ul><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.0-Welcome_to_Unit_3.html">1.3.0 Welcome to Unit 3</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.1-Getting_started_with_the_Vue_CDN.html">1.3.1 Getting started with the Vue CDN</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.2-Vue_methods_and_computed_properties.html">1.3.2 Vue methods and computed properties</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.3-Events_and_adding_to_cart.html">1.3.3 Events and adding to cart</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.4-Introducing_routing_to_our_app.html">1.3.4 Introducing routing to our app</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.5-Fixing_the_add_to_cart_event.html">1.3.5 Fixing the add to cart event</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.6-Adding_the_product_details_page.html">1.3.6 Adding the product details page</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.7-Integrating_Vuex_for_global_state_management.html">1.3.7 Integrating Vuex for global state management</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.8-Consolidating_the_final_components.html">1.3.8 Consolidating the final components</a></li><li><a href="/curriculum\Module-1\Unit-3-Building_UI_with_Vue.js\1.3.9-Closing_thoughts_and_next_steps.html">1.3.9 Closing thoughts and next steps</a></li></ul></details><details><summary>Unit 4 Accessibility</summary><ul><li><a href="/curriculum\Module-1\Unit-4-Accessibility\1.4.1-Inclusive_design.html">1.4.1 Inclusive design</a></li><li><a href="/curriculum\Module-1\Unit-4-Accessibility\1.4.2-Accessibility.html">1.4.2 Accessibility</a></li><li><a href="/curriculum\Module-1\Unit-4-Accessibility\1.4.3-Next_Steps.html">1.4.3 Next Steps</a></li></ul></details><details><summary>Unit 5 End to end testing</summary><ul><li><a href="/curriculum\Module-1\Unit-5-End_to_end_testing\1.5.1-End_to_end_testing.html">1.5.1 End to end testing</a></li><li><a href="/curriculum\Module-1\Unit-5-End_to_end_testing\1.5.2-End_to_end_testing_with_Cypress.html">1.5.2 End to end testing with Cypress</a></li><li><a href="/curriculum\Module-1\Unit-5-End_to_end_testing\1.5.3-Adding_more_test_coverage.html">1.5.3 Adding more test coverage</a></li><li><a href="/curriculum\Module-1\Unit-5-End_to_end_testing\1.5.4-Test_cases_and_equivalence_testing.html">1.5.4 Test cases and equivalence testing</a></li></ul></details></ul></details><details><summary>Module 2</summary><ul><details><summary>Unit 1 Securing RESTful APIs</summary><ul><li><a href="/curriculum\Module-2\Unit-1-Securing_RESTful_APIs\2.1.1-RESTful_APIs_and_Frameworks.html">2.1.1 RESTful APIs and Frameworks</a></li><li><a href="/curriculum\Module-2\Unit-1-Securing_RESTful_APIs\2.1.2-MOVE_TO_BOOTCAMP.html">2.1.2 MOVE TO BOOTCAMP</a></li><li><a href="/curriculum\Module-2\Unit-1-Securing_RESTful_APIs\2.1.2-Password_Hashing.html">2.1.2 Password Hashing</a></li><li><a href="/curriculum\Module-2\Unit-1-Securing_RESTful_APIs\2.1.3-Securing_APIs_with_Basic_Auth.html">2.1.3 Securing APIs with Basic Auth</a></li><li><a href="/curriculum\Module-2\Unit-1-Securing_RESTful_APIs\2.1.4-Next_steps.html">2.1.4 Next steps</a></li></ul></details><details><summary>Unit 2 OAuth with OpenID Connect</summary><ul><li><a href="/curriculum\Module-2\Unit-2-OAuth_with_OpenID_Connect\2.2.1-Introduction_to_OAuth.html">2.2.1 Introduction to OAuth</a></li><li><a href="/curriculum\Module-2\Unit-2-OAuth_with_OpenID_Connect\2.2.1-MOVE-Sessions.html">2.2.1 MOVE Sessions</a></li><li><a href="/curriculum\Module-2\Unit-2-OAuth_with_OpenID_Connect\2.2.2-Securing_APIs_with_OAuth.html">2.2.2 Securing APIs with OAuth</a></li><li><a href="/curriculum\Module-2\Unit-2-OAuth_with_OpenID_Connect\2.2.3-OpenID_Connect.html">2.2.3 OpenID Connect</a></li><li><a href="/curriculum\Module-2\Unit-2-OAuth_with_OpenID_Connect\2.2.4-Module_2_assessment.html">2.2.4 Module 2 assessment</a></li></ul></details></ul></details><details><summary>Module 3</summary><ul><details><summary>Unit 1 The SDLC</summary><ul><li><a href="/curriculum\Module-3\Unit-1-The-SDLC\3.1.1-The_Software_Development_Life_Cycle.html">3.1.1 The Software Development Life Cycle</a></li><li><a href="/curriculum\Module-3\Unit-1-The-SDLC\3.1.2-The_roles_and_responsibilities_in_the_SDLC_with_communication.html">3.1.2 The roles and responsibilities in the SDLC with communication</a></li><li><a href="/curriculum\Module-3\Unit-1-The-SDLC\3.1.3-Communication_in_your_teams.html">3.1.3 Communication in your teams</a></li></ul></details><details><summary>Unit 2 The 7 Princibles of Testing</summary><ul><li><a href="/curriculum\Module-3\Unit-2-The-7-Princibles-of-Testing\3.2.1-The_7_Princibles_of_Testing.html">3.2.1 The 7 Princibles of Testing</a></li><li><a href="/curriculum\Module-3\Unit-2-The-7-Princibles-of-Testing\3.2.2-Continuous_Deployment.html">3.2.2 Continuous Deployment</a></li></ul></details><details><summary>Unit 3 Deployment and Maintenance</summary><ul><li><a href="/curriculum\Module-3\Unit-3-Deployment-and-Maintenance\3.3.1-Containerisation_with_docker.html">3.3.1 Containerisation with docker</a></li><li><a href="/curriculum\Module-3\Unit-3-Deployment-and-Maintenance\3.3.2-Introduction_to_Cloud_Computing.html">3.3.2 Introduction to Cloud Computing</a></li><li><a href="/curriculum\Module-3\Unit-3-Deployment-and-Maintenance\3.3.3-Monitoring_and_Maintenance.html">3.3.3 Monitoring and Maintenance</a></li></ul></details></ul></details><details><summary>Module 4</summary><ul><details><summary>Unit 1 Open Web Application Security Project</summary><ul><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.1-Introduction_to_the_OWASP_Top_Ten.html">4.1.1 Introduction to the OWASP Top Ten</a></li><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.2-Injection_Attacks.html">4.1.2 Injection Attacks</a></li><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.3-Broken_Authentication.html">4.1.3 Broken Authentication</a></li><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.3-Exposing_Sensitive_Data.html">4.1.3 Exposing Sensitive Data</a></li><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.4-Monitoring_for_attacks.html">4.1.4 Monitoring for attacks</a></li><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.5-The_role_of_a_Penetration_Tester.html">4.1.5 The role of a Penetration Tester</a></li><li><a href="/curriculum\Module-4\Unit-1-Open_Web_Application_Security_Project\4.1.6-Next_Steps.html">4.1.6 Next Steps</a></li></ul></details></ul></details></ul></nav>
        <h1>What is middleware?</h1>
<h2>Learning Objectives</h2>
<ul>
<li>Describe the middleware design pattern</li>
<li>Use what you have learnt in previous lessons to secure an API using Basic Auth</li>
</ul>
<h3>Lesson</h3>
<p>Your API should support a `User' resource. A user will need at least a name, email and password:</p>
<table>
<thead>
<tr><th>HTTP Method</th><th>URL</th><th>Status code</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>GET</td><td><code>/users</code></td><td>200</td><td>retrieve all users</td></tr>
<tr><td>POST</td><td><code>/users</code></td><td>201</td><td>create a new user</td></tr>
<tr><td>GET</td><td><code>/users/{id}</code></td><td>200</td><td>retrieve a specific user</td></tr>
<tr><td>PUT</td><td><code>/users/{id}</code></td><td>200</td><td>update a user</td></tr>
<tr><td>DELETE</td><td><code>/users/{id}</code></td><td>200</td><td>delete a user</td></tr>
</tbody>
</table>
<p>Our User resource in an unsecured state is just like any other resource like airports, training shoes or albums. However we are going to treat it differently.</p>
<p>To protect resources we need to authenticate the user making the request. We are using basic auth to do that by putting the <em>username:password</em> in the headers of the request.</p>
<p>Our server now needs to check the request is authentic and from a user it knows before responding. That check needs to happen before we respond.</p>
<p><figure><img src="https://miro.medium.com/max/960/1*Fnreje0WgqdBjjLXop9L0A.png" alt="middleware diagram"><figcaption></figcaption></figure></p>
<p>As that check happens in the middle of the request response cycle, it has been given the name of middleware. This is a generic design pattern you will see in many systems.</p>
<p>A whole series of things can happen in middleware not just authentication, but also authorisation. Thats why the diagram above has 2 middleware rings. There are 2 middlewares the request has to pass through before it gets to the controller. Below is a general pattern for a middleware function.</p>
<pre><code class="language-javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request, response, next</span>) </span>{
  <span class="hljs-comment">// check or change something in the request</span>
  <span class="hljs-comment">// maybe its not ok so from here you might</span>
  <span class="hljs-keyword">return</span> response.code(<span class="hljs-number">403</span>) <span class="hljs-comment">// status code 403 forbidden</span>
  <span class="hljs-comment">// the controller was never reached!</span>
  <span class="hljs-comment">// maybe all is well and you can contiune with the request</span>
  <span class="hljs-comment">// calling next() finishes this middleware and goes onto</span>
  <span class="hljs-comment">// either the next middleware or into the controller/route handler itself</span>
  <span class="hljs-keyword">return</span> next()
}
</code></pre>
<p>❓ What other things might you want to do in middleware?</p>
<p>❓ is the password sent on every request or cached?</p>
<p>We are going to implement middlewares on our server. First of you need to authenticate the request and only accept requests from users your server knows about (the users in your database). We don't want any user to be able to see a list of all the other users, that is our authorisation rule.</p>
<h3>Assignment</h3>
<ul>
<li>Create an API which allows Create, Read, Update and Delete of a User using either SpringBoot or Node.js</li>
<li>Enhance your API to protect your User resources with Basic Authentication (see code examples below) and check the incoming username and password against the details held in the database you created in the previous lesson</li>
<li>(Optional) Create a simple form which sends a username and password to your API using Basic Auth (i.e. simulates what Postman was doing in the previous lesson).</li>
</ul>
<p>|Javascript|Java|</p>
<pre><code class="language-javascript"><span class="hljs-comment">// check for a basic auth header with correct credentials</span>
app.use(basicAuth({
  <span class="hljs-attr">authorizer</span>: dbAuthorizer, <span class="hljs-comment">// customer authorizer,</span>
  <span class="hljs-attr">authorizeAsync</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// we check the db which makes this async</span>
  <span class="hljs-attr">challenge</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">unauthorizedResponse</span>: <span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`unauthorized. ip: <span class="hljs-subst">${req.ip}</span>`</span>
  }
}));

<span class="hljs-comment">// our custom async authorizer middleware, this is called for each request</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dbAuthorizer</span>(<span class="hljs-params">username, password, callback</span>) </span>{
  <span class="hljs-keyword">const</span> sql = <span class="hljs-string">&quot;select password from users where username = ?;&quot;</span>;
  db.get(sql, [username], <span class="hljs-keyword">async</span> (err, user) =&gt; {
    err ? callback(err) : bcrypt.compare(password, user.password, callback);
  });
</code></pre>
<pre><code class="language-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataSource dataSource;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">// do not use the line below in production apps!!</span>
        httpSecurity.csrf().disable(); <span class="hljs-comment">// hack to support DELETE method</span>
        httpSecurity.authorizeRequests().anyRequest().authenticated()
                .and().httpBasic();
    }

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureGlobal</span><span class="hljs-params">(AuthenticationManagerBuilder authentication)</span>
            <span class="hljs-keyword">throws</span> Exception </span>{
        <span class="hljs-comment">// use jdbc authentication (for in memory authentication use authentication.inMemoryAuthentication())</span>
        authentication.jdbcAuthentication()
                .dataSource(dataSource)
                .authoritiesByUsernameQuery(<span class="hljs-string">&quot;select username,authority &quot;</span>
                        + <span class="hljs-string">&quot;from authorities &quot;</span>
                        + <span class="hljs-string">&quot;where username = ?&quot;</span>)
                .usersByUsernameQuery(
                        <span class="hljs-string">&quot;select username, password, &#x27;true&#x27; as enabled from users where username = ?&quot;</span>);

    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// specify we want the password hashed using bcrypt</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
    }
}
</code></pre>
<hr>
<h1>Session based Auth</h1>
<h2>Learning Objectives</h2>
<ul>
<li>Understand the limitations of Basic Auth</li>
<li>Know why and how to use sessions on a server</li>
</ul>
<h2>Pre-requisites</h2>
<ul>
<li>Ensure you have the Postman application installed</li>
</ul>
<h2>Materials needed</h2>
<ul>
<li>Postman application</li>
<li>VS Code (for Javascript development) or IntelliJ (for Java development)</li>
</ul>
<h2>What's wrong with Basic Auth?</h2>
<ul>
<li>The password is sent over the wire in base64 encoding which can be easily decoded (if Basic Auth is used, it should always go over HTTPS for this reason)</li>
<li>The password is sent repeatedly i.e. on each request meaning there is a large attack window</li>
<li>The password is cached by the web browser, therefore it could be silently reused by any other request to the server e.g. CSRF</li>
<li>The password may be stored permanently in the browser hence could be stolen by another user on a shared machine</li>
</ul>
<h2>Sessions</h2>
<p>Wouldn't it be much better if after being authenticated the server could keep track of which users it had already checked the passwords for. This is the purpose of sessions on a server. They are a means by which the server can keep track of who is who. Without sessions our server will just treat each request the same.</p>
<p>Lets have a look at trying to manage state on a server. Start a new project just for this Counter example. Lets be really simple and just imagine we have a counter.</p>
<pre><code class="language-javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> </span>{
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.value = <span class="hljs-number">1</span>
    }

    <span class="hljs-function"><span class="hljs-title">inc</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.value += <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value.toString()
    }
}
</code></pre>
<p>We want to expose this to our users so they can make requests and receive incrementing values i.e. 1,2,3,4,5 etc</p>
<pre><code class="language-javascript">app.get(<span class="hljs-string">&#x27;/counter&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> counter = <span class="hljs-keyword">new</span> Counter()
    res.send(counter.inc())
})
</code></pre>
<p>❓ What is the problem with this?</p>
<p>Lets pull the counter out of the route and have it in the scope of the server instance:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> counter = <span class="hljs-keyword">new</span> Counter()

app.get(<span class="hljs-string">&#x27;/counter&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    res.send(counter.inc())
})
</code></pre>
<p>❓ What is the problem with this? (try different browser windows)</p>
<p>The behaviour we are after is each connected client gets their own dedicated counter. So as they refresh their individual page, their personal counter increments.</p>
<p>For this we will need to extend our server by adding sessions. The session object will be added to the request object. Each individually connected client will be allocated a <code>req.session.id</code> unique to them and there interaction with the server. On the session object we can store values for that connection. For example:</p>
<pre><code class="language-javascript">req.session.user_id = user.id
</code></pre>
<p>You can only store JSON stringable values so our instance of our counter cannot be stored as it will get turned into the string representation of the class instance. No good to us. So we will use the <code>req.session.id</code> as a hashkey so we can lookup the counter for each particular connected client.</p>
<h3>Use Sessions</h3>
<p>To add sessions <code>npm i express-session</code> then use the following config:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-session&#x27;</span>)
<span class="hljs-keyword">const</span> sessionSettings = {
    <span class="hljs-attr">secret</span>: <span class="hljs-string">&quot;best cohort ever&quot;</span>,
    <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">true</span>
}
app.use(session(sessionSettings))
</code></pre>
<p>Update your Counter class to keep track of every instance (use a static property).</p>
<pre><code class="language-javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> </span>{
    <span class="hljs-keyword">static</span> lookup = {}
    
    <span class="hljs-function"><span class="hljs-title">constructor</span>(<span class="hljs-params">id</span>)</span> {
        <span class="hljs-built_in">this</span>.value = <span class="hljs-number">1</span>
        Counter.lookup[id] = <span class="hljs-built_in">this</span> <span class="hljs-comment">// every counter we create is added to the lookup hash map which we can access at Counter.lookup</span>
    }

    <span class="hljs-function"><span class="hljs-title">inc</span>(<span class="hljs-params"></span>)</span> {
        <span class="hljs-built_in">this</span>.value += <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value.toString()
    }
}
</code></pre>
<p>Add a middleware function that will run on every request this makes sure new requests have an instance of the counter they can access with their session id:</p>
<pre><code class="language-javascript">app.use(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    Counter.lookup[req.session.id] = Counter.lookup[req.session.id] || <span class="hljs-keyword">new</span> Counter(req.session.id)
    next()
})
</code></pre>
<p>finally in the route return the next value</p>
<pre><code class="language-javascript">app.get(<span class="hljs-string">&#x27;/counter&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    res.send(Counter.lookup[req.session.id].inc())
})
</code></pre>
<p>❓ How can we use this functionality to authenticate a user only once?</p>
<p>This is now a more familiar concept to you. Getting a session assigned to you is like 'logging' in. To 'log out' you just remove that counter from the session.</p>
<h2>Assignment</h2>
<ul>
<li>Implement sessions on your server</li>
<li>Add <code>/login</code> and <code>/logout</code> routes</li>
<li>The <code>/login</code> route should be the only route that accepts a Basic Auth request</li>
<li>Once a user is authenticated with Basic Auth add them to a session</li>
<li>Update <code>/users/:id</code> to only return the user info if the user is in a session</li>
<li>If a user is in a session and visits the <code>/logout</code> route this should end their session,  and they will no longer be able to access <code>/users/:id</code></li>
<li>Put your solution on Github and share it with your coach</li>
</ul>
<h2>Further resources</h2>
<p><iframe src="https://www.youtube.com/embed/B2MbcnJmGuk" width="100%" height="444px" allowfullscreen frameborder=0></iframe></p>
<p>In this video Bernard demo's the Counter example.</p>

        <script src="/curriculum/js/tabbed-code-blocks.js"></script>
        <script>
            function toggleNav() {
                const button = document.getElementById('navigation-toggle')
                const isAriaExp = button.getAttribute('aria-expanded')
                const newAriaExp = (isAriaExp == "false") ? "true" : "false"
                button.setAttribute('aria-expanded', newAriaExp)
                const nav = document.getElementById('navigation')
                nav.style.display = nav.offsetParent ? 'none' : 'block'
            }
        </script>
    </body>
</html>